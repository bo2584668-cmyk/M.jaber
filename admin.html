<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ù…Ø´Ø±Ù | Ù…Ù†ØµØ© Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø¨Ø±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
        body { background:#f0f2f5; }
        .admin-nav { background:#1e3c5c; color:white; padding:1rem 5%; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
        .admin-nav h2 { font-size:1.5rem; display:flex; align-items:center; gap:0.5rem; }
        .admin-nav h2 i { color:#f9a826; }
        .admin-nav button { background:#dc3545; color:white; border:none; padding:0.6rem 2rem; border-radius:50px; cursor:pointer; font-weight:700; transition:0.3s; display:flex; align-items:center; gap:0.5rem; }
        .admin-nav button:hover { background:#b02a37; transform:translateY(-2px); }
        .container { max-width:1400px; margin:2rem auto; padding:0 2rem; }
        .tabs { display:flex; gap:1rem; margin-bottom:2rem; flex-wrap:wrap; }
        .tab { padding:0.8rem 2rem; background:white; border:none; border-radius:50px; cursor:pointer; font-weight:700; color:#1e3c5c; box-shadow:0 2px 8px rgba(0,0,0,0.05); transition:0.3s; display:flex; align-items:center; gap:0.5rem; }
        .tab.active { background:#1e3c5c; color:white; }
        .tab-content { background:white; padding:2rem; border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,0.05); }
        .form-group { margin-bottom:1.5rem; }
        .form-group label { display:block; margin-bottom:0.5rem; font-weight:700; color:#1e3c5c; }
        .form-group input, .form-group textarea, .form-group select { width:100%; padding:0.8rem 1rem; border:2px solid #e0e7ef; border-radius:12px; font-size:1rem; transition:0.3s; }
        .form-group textarea { resize:vertical; min-height:100px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color:#f9a826; outline:none; }
        .btn-primary { background:#1e3c5c; color:white; border:none; padding:0.8rem 2rem; border-radius:50px; cursor:pointer; font-weight:700; font-size:1rem; transition:0.3s; display:inline-flex; align-items:center; gap:0.5rem; }
        .btn-primary:hover { background:#0f2b44; transform:translateY(-2px); }
        .btn-success { background:#28a745; color:white; border:none; padding:0.4rem 1rem; border-radius:50px; cursor:pointer; font-weight:600; transition:0.3s; }
        .btn-success:hover { background:#218838; }
        .btn-warning { background:#ffc107; color:#1e3c5c; border:none; padding:0.4rem 1rem; border-radius:50px; cursor:pointer; font-weight:600; transition:0.3s; }
        .btn-warning:hover { background:#e0a800; }
        .btn-danger { background:#dc3545; color:white; border:none; padding:0.4rem 1rem; border-radius:50px; cursor:pointer; font-weight:600; transition:0.3s; }
        .btn-danger:hover { background:#b02a37; }
        table { width:100%; border-collapse:collapse; margin-top:1rem; font-size:0.9rem; }
        th, td { padding:0.8rem; text-align:center; border-bottom:1px solid #eee; }
        th { background:#f8f9fa; color:#1e3c5c; font-weight:700; }
        .status-badge { background:#f9a826; color:white; padding:0.3rem 1rem; border-radius:50px; font-size:0.8rem; font-weight:600; display:inline-block; }
        .status-badge.active { background:#28a745; }
        .status-badge.inactive { background:#6c757d; }
        .status-badge.expired { background:#dc3545; }
        .days-remaining { font-weight:700; }
        .days-remaining.urgent { color:#dc3545; }
        .loading { text-align:center; padding:2rem; color:#1e3c5c; }
        .popup-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center; z-index:1000; }
        .popup { background:white; padding:2rem; border-radius:20px; width:90%; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
        .popup h3 { margin-bottom:1.5rem; color:#1e3c5c; }
        .popup select, .popup button { width:100%; padding:0.8rem; margin-bottom:1rem; border-radius:10px; border:2px solid #e0e7ef; }
        .popup button { background:#1e3c5c; color:white; font-weight:700; border:none; cursor:pointer; }
        .popup button:hover { background:#0f2b44; }
        .popup .cancel { background:#6c757d; }
        .popup .cancel:hover { background:#5a6268; }
    </style>
</head>
<body>
    <div class="admin-nav">
        <h2><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù - Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø¨Ø±</h2>
        <button id="logoutAdmin"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="courses"><i class="fas fa-book"></i> Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</button>
            <button class="tab" data-tab="users"><i class="fas fa-users"></i> Ø§Ù„Ø·Ù„Ø§Ø¨</button>
            <button class="tab" data-tab="expired"><i class="fas fa-hourglass-end"></i> Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù…</button>
            <button class="tab" data-tab="addCourse"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª -->
        <div id="coursesTab" class="tab-content">
            <h3 style="margin-bottom:1rem;">ğŸ“š Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„ØµÙˆØ±Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="coursesBody"><tr><td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨) -->
        <div id="usersTab" class="tab-content" style="display:none;">
            <h3 style="margin-bottom:1rem;">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="usersBody"><tr><td colspan="9" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù… -->
        <div id="expiredTab" class="tab-content" style="display:none;">
            <h3 style="margin-bottom:1rem;">â³ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù…</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¨Ø±ÙŠØ¯</th><th>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</th><th>Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</th><th>Ø§Ù„Ø¨Ø§Ù‚Ø©</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="expiredBody"><tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ -->
        <div id="addCourseTab" class="tab-content" style="display:none;">
            <h3 style="margin-bottom:1.5rem;">â• Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³ Ø¬Ø¯ÙŠØ¯</h3>
            <form id="courseForm">
                <div class="form-group">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <input type="text" id="title" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø±Ø­ Ø§Ù„ØªÙ…ÙŠÙŠØ²" required>
                </div>
                <div class="form-group">
                    <label>ÙˆØµÙ Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <textarea id="description" rows="3" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ±..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                    <select id="grade" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø£ÙˆÙ„ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø«Ø§Ù†ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø«Ø§Ù„Ø« Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
                        <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (YouTube - Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="url" id="videoUrl" placeholder="https://youtube.com/watch?v=...">
                </div>
                <div class="form-group">
                    <label>Ø£Ùˆ ÙƒÙˆØ¯ Ø§Ù„ØªØ¶Ù…ÙŠÙ† (iframe) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
                    <textarea id="iframeCode" rows="4" placeholder="Ø¶Ø¹ ÙƒÙˆØ¯ iframe ÙƒØ§Ù…Ù„ Ù‡Ù†Ø§"></textarea>
                    <small style="color:#666;">Ø§ØªØ±Ùƒ Ø£Ø­Ø¯ Ø§Ù„Ø­Ù‚Ù„ÙŠÙ† Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</small>
                </div>
                <div class="form-group">
                    <label>ØµÙˆØ±Ø© Ø§Ù„ÙƒÙˆØ±Ø³ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input type="file" id="courseImage" accept="image/*">
                </div>
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„ÙƒÙˆØ±Ø³</label>
                    <select id="isFree" required>
                        <option value="true">Ù…Ø¬Ø§Ù†ÙŠ</option>
                        <option value="false">Ù…Ø¯ÙÙˆØ¹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ (ØªÙ‚Ø¯ÙŠØ±ÙŠ)</label>
                    <input type="number" id="videoCount" value="12" min="1">
                </div>
                <button type="submit" class="btn-primary" id="submitBtn">
                    <i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ±Ø³
                </button>
            </form>
        </div>
    </div>

    <!-- Popup Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø© -->
    <div id="subscriptionPopup" class="popup-overlay" style="display:none;">
        <div class="popup">
            <h3><i class="fas fa-calendar-alt"></i> ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
            <select id="subscriptionType">
                <option value="monthly">Ø´Ù‡Ø±ÙŠ (31 ÙŠÙˆÙ…)</option>
                <option value="semester">ØªØ±Ù… (5 Ø´Ù‡ÙˆØ±)</option>
                <option value="yearly">Ø³Ù†ÙˆÙŠ (10 Ø´Ù‡ÙˆØ±)</option>
            </select>
            <button id="confirmActivate"><i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªÙØ¹ÙŠÙ„</button>
            <button class="cancel" id="cancelPopup"><i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, Timestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø­Ø§Ù„Ø© popup
        let currentUserId = null;
        let currentUserEmail = null;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== 'bo2584668@gmail.com') {
                window.location.href = 'login.html';
            } else {
                loadCourses();
                loadUsers();
            }
        });

        document.getElementById('logoutAdmin').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });

        // Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
                if (tabName === 'courses') document.getElementById('coursesTab').style.display = 'block';
                else if (tabName === 'users') {
                    document.getElementById('usersTab').style.display = 'block';
                    loadUsers(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù„Ù„ØªØ­Ø¯ÙŠØ«
                }
                else if (tabName === 'expired') {
                    document.getElementById('expiredTab').style.display = 'block';
                    loadExpiredUsers();
                }
                else if (tabName === 'addCourse') document.getElementById('addCourseTab').style.display = 'block';
            });
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª
        async function loadCourses() {
            const tbody = document.getElementById('coursesBody');
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            const snapshot = await getDocs(collection(db, 'courses'));
            tbody.innerHTML = '';
            snapshot.forEach(docSnap => {
                const c = docSnap.data();
                const imageCell = c.imageUrl 
                    ? `<img src="${c.imageUrl}" width="50" height="50" style="border-radius:10px; object-fit:cover;">` 
                    : '<i class="fas fa-image" style="color:#aaa;"></i>';
                const row = `<tr>
                    <td><strong>${c.title}</strong></td>
                    <td>${c.grade || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                    <td><span class="status-badge ${c.isFree ? 'active' : 'inactive'}">${c.isFree ? 'Ù…Ø¬Ø§Ù†ÙŠ' : 'Ù…Ø¯ÙÙˆØ¹'}</span></td>
                    <td>${imageCell}</td>
                    <td><button class="btn-danger" onclick="deleteCourse('${docSnap.id}')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }
        window.deleteCourse = async (id) => {
            if (confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
                await deleteDoc(doc(db, 'courses', id));
                loadCourses();
            }
        };

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©
        function calculateEndDate(startDate, type) {
            const date = new Date(startDate);
            if (type === 'monthly') {
                date.setDate(date.getDate() + 31);
            } else if (type === 'semester') {
                date.setMonth(date.getMonth() + 5);
            } else if (type === 'yearly') {
                date.setMonth(date.getMonth() + 10); // 10 Ø´Ù‡ÙˆØ±
            }
            return date;
        }

        // Ø¯Ø§Ù„Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        async function activateSubscription(userId, type) {
            const now = new Date();
            const endDate = calculateEndDate(now, type);
            await updateDoc(doc(db, 'users', userId), {
                subscriptionType: type,
                startDate: Timestamp.fromDate(now),
                endDate: Timestamp.fromDate(endDate),
                isActive: true
            });
            loadUsers();
            loadExpiredUsers(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        async function loadUsers() {
            const tbody = document.getElementById('usersBody');
            tbody.innerHTML = '<tr><td colspan="9" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            const snapshot = await getDocs(collection(db, 'users'));
            tbody.innerHTML = '';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ù„ÙƒÙ„ Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
            const now = Timestamp.now();
            for (const docSnap of snapshot.docs) {
                const u = docSnap.data();
                let isActive = u.isActive || false;
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ endDate ÙˆØ§Ù†ØªÙ‡Ù‰ØŒ Ù†Ø¹Ø·Ù„ Ø§Ù„Ø­Ø§Ù„Ø©
                if (u.endDate && u.endDate.toDate() < now.toDate()) {
                    if (isActive) {
                        isActive = false;
                        await updateDoc(docSnap.ref, { isActive: false });
                    }
                }
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                let daysRemaining = '---';
                let statusClass = 'inactive';
                let statusText = 'ØºÙŠØ± Ù…ÙØ¹Ù„';
                if (u.endDate) {
                    const end = u.endDate.toDate();
                    const diff = Math.ceil((end - now.toDate()) / (1000 * 60 * 60 * 24));
                    if (diff > 0) {
                        daysRemaining = diff + ' ÙŠÙˆÙ…';
                        statusClass = 'active';
                        statusText = 'Ù…ÙØ¹Ù„';
                    } else {
                        daysRemaining = 'ğŸš« Ù…Ù†ØªÙ‡ÙŠ';
                        statusClass = 'expired';
                        statusText = 'Ù…Ù†ØªÙ‡ÙŠ';
                    }
                } else {
                    daysRemaining = '---';
                }

                // ØªØ±Ø¬Ù…Ø© Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø©
                let typeText = '---';
                if (u.subscriptionType === 'monthly') typeText = 'Ø´Ù‡Ø±ÙŠ';
                else if (u.subscriptionType === 'semester') typeText = 'ØªØ±Ù…';
                else if (u.subscriptionType === 'yearly') typeText = 'Ø³Ù†ÙˆÙŠ';

                const row = `<tr>
                    <td>${u.fullName || '---'}</td>
                    <td>${u.email}</td>
                    <td>${u.grade || '---'}</td>
                    <td>${u.whatsapp || '---'}</td>
                    <td>${typeText}</td>
                    <td>${u.startDate ? new Date(u.startDate.toDate()).toLocaleDateString('ar-EG') : '---'}</td>
                    <td>${u.endDate ? new Date(u.endDate.toDate()).toLocaleDateString('ar-EG') : '---'}</td>
                    <td class="days-remaining ${diff <= 3 && diff > 0 ? 'urgent' : ''}">${daysRemaining}</td>
                    <td>
                        ${!u.endDate || u.endDate.toDate() < now.toDate() 
                            ? `<button class="btn-success" onclick="showActivatePopup('${docSnap.id}', '${u.email}')"><i class="fas fa-play"></i> ØªÙØ¹ÙŠÙ„</button>` 
                            : `<button class="btn-warning" onclick="deactivateUser('${docSnap.id}')"><i class="fas fa-pause"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„</button>`}
                    </td>
                </tr>`;
                tbody.innerHTML += row;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ø´ØªØ±Ø§ÙƒØ§ØªÙ‡Ù… ÙÙ‚Ø·
        async function loadExpiredUsers() {
            const tbody = document.getElementById('expiredBody');
            tbody.innerHTML = '<tr><td colspan="7" class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
            const snapshot = await getDocs(collection(db, 'users'));
            tbody.innerHTML = '';
            const now = Timestamp.now();
            for (const docSnap of snapshot.docs) {
                const u = docSnap.data();
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ (Ù„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ endDate Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰)
                if (!u.endDate || u.endDate.toDate() < now.toDate()) {
                    const row = `<tr>
                        <td>${u.fullName || '---'}</td>
                        <td>${u.email}</td>
                        <td>${u.grade || '---'}</td>
                        <td>${u.whatsapp || '---'}</td>
                        <td>${u.subscriptionType ? (u.subscriptionType === 'monthly' ? 'Ø´Ù‡Ø±ÙŠ' : u.subscriptionType === 'semester' ? 'ØªØ±Ù…' : 'Ø³Ù†ÙˆÙŠ') : '---'}</td>
                        <td>${u.endDate ? new Date(u.endDate.toDate()).toLocaleDateString('ar-EG') : '---'}</td>
                        <td><button class="btn-success" onclick="showActivatePopup('${docSnap.id}', '${u.email}')"><i class="fas fa-play"></i> ØªÙØ¹ÙŠÙ„</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                }
            }
        }

        // Ø¥Ø¸Ù‡Ø§Ø± popup Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©
        window.showActivatePopup = (userId, userEmail) => {
            currentUserId = userId;
            currentUserEmail = userEmail;
            document.getElementById('subscriptionPopup').style.display = 'flex';
        };

        // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙØ¹ÙŠÙ„ (ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ)
        window.deactivateUser = async (id) => {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ØŸ')) {
                await updateDoc(doc(db, 'users', id), { isActive: false });
                loadUsers();
                loadExpiredUsers();
            }
        };

        // Ù…Ø¹Ø§Ù„Ø¬Ø© popup
        document.getElementById('confirmActivate').addEventListener('click', async () => {
            const type = document.getElementById('subscriptionType').value;
            if (currentUserId) {
                await activateSubscription(currentUserId, type);
                document.getElementById('subscriptionPopup').style.display = 'none';
                currentUserId = null;
            }
        });

        document.getElementById('cancelPopup').addEventListener('click', () => {
            document.getElementById('subscriptionPopup').style.display = 'none';
            currentUserId = null;
        });

        // Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ±Ø³
        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';

            const title = document.getElementById('title').value.trim();
            const description = document.getElementById('description').value.trim();
            const grade = document.getElementById('grade').value;
            const videoUrl = document.getElementById('videoUrl').value.trim();
            const iframeCode = document.getElementById('iframeCode').value.trim();
            const isFree = document.getElementById('isFree').value === 'true';
            const videoCount = parseInt(document.getElementById('videoCount').value) || 12;
            const imageFile = document.getElementById('courseImage').files[0];

            try {
                let imageUrl = '';
                if (imageFile) {
                    if (imageFile.size > 5 * 1024 * 1024) throw new Error('Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ø§Ù„Ø­Ø¯ 5 Ù…ÙŠØ¬Ø§)');
                    const storageRef = ref(storage, `courses/${Date.now()}_${imageFile.name}`);
                    await uploadBytes(storageRef, imageFile);
                    imageUrl = await getDownloadURL(storageRef);
                }

                await addDoc(collection(db, 'courses'), {
                    title,
                    description,
                    grade,
                    videoUrl,
                    iframeCode,
                    isFree,
                    videoCount,
                    imageUrl,
                    createdAt: Timestamp.now()
                });

                alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ±Ø³ Ø¨Ù†Ø¬Ø§Ø­!');
                document.getElementById('courseForm').reset();
                loadCourses();
                document.querySelector('[data-tab="courses"]').click();
            } catch (error) {
                alert('âŒ Ø®Ø·Ø£: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Ù†Ø´Ø± Ø§Ù„ÙƒÙˆØ±Ø³';
            }
        });
    </script>
</body>
</html>
