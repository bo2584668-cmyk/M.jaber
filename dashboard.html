<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ù…Ù†ØµØ© Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø¨Ø±</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts - Tajawal -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
        body { background:#f5f7fa; }
        .navbar {
            background:white; box-shadow:0 2px 10px rgba(0,0,0,0.05); padding:1rem 5%;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
        }
        .logo { font-size:1.6rem; font-weight:900; color:#1e3c5c; }
        .nav-links { display:flex; gap:2rem; }
        .nav-links a { text-decoration:none; color:#1e2a3a; font-weight:600; transition:0.3s; }
        .nav-links a:hover { color:#f9a826; }
        .logout-btn { background:#dc3545; color:white; border:none; padding:0.5rem 1.5rem; border-radius:50px; cursor:pointer; font-weight:600; }
        .container { max-width:1300px; margin:2rem auto; padding:0 2rem; }
        
        /* ÙƒØ±Øª ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ */
        .welcome-card {
            background:linear-gradient(145deg, #1e3c5c, #0f2b44); color:white; padding:2rem; border-radius:30px; margin-bottom:3rem;
            box-shadow:0 10px 30px rgba(0,0,0,0.2); display:flex; flex-wrap:wrap; gap:2rem; justify-content:space-between; align-items:center;
        }
        .welcome-text h1 { font-size:2.2rem; margin-bottom:0.5rem; }
        .welcome-text p { opacity:0.9; }
        .subscription-info {
            background:rgba(255,255,255,0.1); padding:1.5rem; border-radius:20px; min-width:250px; backdrop-filter:blur(5px);
        }
        .subscription-info h3 { margin-bottom:1rem; font-size:1.3rem; border-bottom:1px solid rgba(255,255,255,0.2); padding-bottom:0.5rem; }
        .sub-item { display:flex; align-items:center; gap:0.8rem; margin-bottom:1rem; }
        .sub-item i { color:#f9a826; width:25px; }
        .badge-active { background:#28a745; color:white; padding:0.3rem 1.2rem; border-radius:50px; display:inline-block; font-weight:700; }
        .badge-inactive { background:#6c757d; color:white; padding:0.3rem 1.2rem; border-radius:50px; display:inline-block; font-weight:700; }
        .remaining-days { font-size:1.2rem; font-weight:700; color:#f9a826; }
        .subscribe-btn {
            background:#f9a826; color:#1e2a3a; padding:0.5rem 1.5rem; border-radius:50px; text-decoration:none; font-weight:700;
            display:inline-block; transition:0.3s; border:none; cursor:pointer;
        }
        .subscribe-btn:hover { transform:translateY(-2px); box-shadow:0 5px 15px rgba(249,168,38,0.3); }
        
        /* Ù‚Ø³Ù… Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© */
        .section-title { display:flex; justify-content:space-between; align-items:center; margin:2rem 0 1rem; }
        .section-title h2 { color:#1e3c5c; }
        .section-title a { color:#f9a826; text-decoration:none; font-weight:600; }
        .courses-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:2rem; }
        .course-card {
            background:white; border-radius:20px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,0.05);
            transition:0.3s; display:flex; flex-direction:column;
        }
        .course-card:hover { transform:translateY(-5px); box-shadow:0 15px 30px rgba(0,0,0,0.1); }
        .course-image {
            height:150px; background:linear-gradient(145deg,#1e3c5c,#0f2b44); display:flex; align-items:center; justify-content:center;
            color:white; font-size:3rem; position:relative;
        }
        .course-image img { width:100%; height:100%; object-fit:cover; }
        .course-tag {
            position:absolute; top:10px; right:10px; background:#f9a826; color:white; padding:0.3rem 1rem;
            border-radius:50px; font-size:0.8rem; font-weight:700;
        }
        .course-details { padding:1.5rem; flex:1; }
        .course-details h3 { color:#1e3c5c; margin-bottom:0.5rem; }
        .course-details p { color:#666; font-size:0.9rem; margin-bottom:1rem; }
        .course-meta { display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:1rem; margin-top:auto; }
        .badge { background:#f9a826; color:white; padding:0.2rem 1rem; border-radius:50px; font-size:0.8rem; }
        .badge.free { background:#28a745; }
        .badge.paid { background:#dc3545; }
        .view-btn {
            display:block; background:#f0f5fa; color:#1e3c5c; text-align:center; padding:0.8rem;
            text-decoration:none; font-weight:600; border-radius:0 0 20px 20px; transition:0.3s;
        }
        .view-btn:hover { background:#1e3c5c; color:white; }
        .loading { grid-column:1/-1; text-align:center; padding:2rem; color:#1e3c5c; }
        
        @media (max-width:768px) {
            .navbar { flex-direction:column; gap:1rem; }
            .nav-links { gap:1rem; }
            .welcome-card { flex-direction:column; text-align:center; }
            .subscription-info { width:100%; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">Ù…Ù†ØµØ© Ù…Ø­Ù…Ø¯ Ø¬Ø§Ø¨Ø±</div>
        <div class="nav-links">
            <a href="dashboard.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
            <a href="courses.html">ÙƒÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª</a>
            <a href="subscription.html">Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</a>
        </div>
        <button class="logout-btn" id="logout"><i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </nav>

    <div class="container">
        <!-- ÙƒØ±Øª ØªØ±Ø­ÙŠØ¨ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ -->
        <div class="welcome-card" id="welcomeCard">
            <div class="welcome-text">
                <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="userName">...</span> ğŸ‘‹</h1>
                <p>Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ ÙŠÙˆÙ…Ø§Ù‹ Ø¯Ø±Ø§Ø³ÙŠØ§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹. ØªØµÙØ­ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø³Ø¨ Ù…Ø±Ø­Ù„ØªÙƒ.</p>
            </div>
            <div class="subscription-info" id="subscriptionInfo">
                <!-- ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¹Ø¨Ø± JavaScript -->
            </div>
        </div>

        <div class="section-title">
            <h2>ÙƒÙˆØ±Ø³Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© Ù„Ùƒ</h2>
            <a href="courses.html">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ <i class="fas fa-arrow-left"></i></a>
        </div>

        <div class="courses-grid" id="coursesContainer">
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            document.getElementById('userName').textContent = user.displayName || 'Ø·Ø§Ù„Ø¨';

            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                displaySubscriptionInfo(userData);
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø­Ø³Ø¨ Ù…Ø±Ø­Ù„ØªÙ‡
                loadSuggestedCourses(userData.grade);
            }
        });

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        function displaySubscriptionInfo(userData) {
            const infoDiv = document.getElementById('subscriptionInfo');
            
            // Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (isActive boolean)
            const isActive = userData.isActive || false;
            
            // ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹) - Ù†ÙØªØ±Ø¶ Ø£Ù†Ù‡ Ø­Ù‚Ù„ subscriptionEndDate (timestamp)
            const endDate = userData.subscriptionEndDate ? new Date(userData.subscriptionEndDate.seconds * 1000) : null;
            const now = new Date();
            
            let remainingDays = 0;
            if (endDate && endDate > now) {
                const diffTime = endDate - now;
                remainingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            } else if (endDate && endDate <= now) {
                // Ù…Ù†ØªÙ‡ÙŠØŒ Ù†Ø¹ØªØ¨Ø±Ù‡ ØºÙŠØ± Ù†Ø´Ø· Ø±ØºÙ… Ø£Ù† isActive Ù‚Ø¯ ÙŠÙƒÙˆÙ† true (ÙŠØ­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ«)
                isActive = false;
            }

            // Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø§Ù‚Ø© (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ userData.plan)
            const plan = userData.plan || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

            // Ø¨Ù†Ø§Ø¡ HTML
            let html = `
                <h3><i class="fas fa-crown"></i> Ø§Ø´ØªØ±Ø§ÙƒÙŠ</h3>
                <div class="sub-item">
                    <i class="fas fa-circle ${isActive ? 'active' : 'inactive'}"></i>
                    <span>Ø§Ù„Ø­Ø§Ù„Ø©: <span class="${isActive ? 'badge-active' : 'badge-inactive'}">${isActive ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}</span></span>
                </div>
            `;

            if (isActive) {
                html += `
                    <div class="sub-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Ø§Ù„Ø¨Ø§Ù‚Ø©: ${plan}</span>
                    </div>
                    <div class="sub-item">
                        <i class="fas fa-hourglass-half"></i>
                        <span>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${endDate ? endDate.toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    <div class="remaining-days">
                        <i class="fas fa-clock"></i> Ù…ØªØ¨Ù‚ÙŠ: ${remainingDays} ÙŠÙˆÙ…
                    </div>
                `;
            } else {
                html += `
                    <div class="sub-item">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>Ø§Ø´ØªØ±Ø§ÙƒÙƒ ØºÙŠØ± Ù…ÙØ¹Ù„ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©.</span>
                    </div>
                    <a href="subscription.html" class="subscribe-btn"><i class="fab fa-whatsapp"></i> Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</a>
                `;
            }

            infoDiv.innerHTML = html;
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
        async function loadSuggestedCourses(grade) {
            const container = document.getElementById('coursesContainer');
            container.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

            const q = query(collection(db, 'courses'), where('grade', '==', grade));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                container.innerHTML = '<div class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ±Ø³Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù…Ø±Ø­Ù„ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                return;
            }

            container.innerHTML = '';
            querySnapshot.forEach((docSnap) => {
                const course = docSnap.data();
                const card = document.createElement('div');
                card.className = 'course-card';

                const imageHtml = course.imageUrl 
                    ? `<img src="${course.imageUrl}" alt="${course.title}">`
                    : `<i class="fas fa-play-circle"></i>`;

                card.innerHTML = `
                    <div class="course-image">
                        ${imageHtml}
                        <span class="course-tag">${course.grade}</span>
                    </div>
                    <div class="course-details">
                        <h3>${course.title}</h3>
                        <p>${course.description.substring(0, 60)}...</p>
                        <div class="course-meta">
                            <span><i class="fas fa-video"></i> ${course.videoCount || 10} Ø¯Ø±Ø³</span>
                            <span class="badge ${course.isFree ? 'free' : 'paid'}">${course.isFree ? 'Ù…Ø¬Ø§Ù†ÙŠ' : 'Ù…Ø¯ÙÙˆØ¹'}</span>
                        </div>
                    </div>
                    <a href="course-details.html?id=${docSnap.id}" class="view-btn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</a>
                `;
                container.appendChild(card);
            });
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        document.getElementById('logout').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
