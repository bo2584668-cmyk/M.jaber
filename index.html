<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أكاديمية الأستاذ محمد جابر | المنصة التعليمية المتكاملة</title>
    <!-- Tailwind + Fonts + Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- GSAP (اختياري) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Firebase Firestore فقط (بدون Auth) -->
    <script type="module">
        // استيراد Firebase Firestore فقط (v9+)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // إعدادات Firebase (خاصة بك)
        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb",
            measurementId: "G-C7L0T2QHL8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // تعريض db للاستخدام العام
        window.db = db;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
    </script>
    <style>
        body { font-family: 'Cairo', sans-serif; background: #f9fafb; }
        .glass { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .course-card { transition: all 0.3s ease; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 20px 30px -10px rgba(0,0,0,0.15); }
        .admin-tab { @apply px-6 py-3 font-bold rounded-full transition-all; }
        .admin-tab.active { @apply bg-blue-600 text-white; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        .float-anim { animation: float 6s infinite; }
    </style>
</head>
<body class="text-gray-800 overflow-x-hidden">

    <!-- ========== HEADER ========== -->
    <header id="mainHeader" class="fixed top-0 w-full z-50 transition-all duration-300 h-20 flex items-center bg-white/90 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <a href="#" onclick="navigate('home'); return false;" class="flex items-center gap-2">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center">
                    <i class="fas fa-graduation-cap text-white"></i>
                </div>
                <span class="font-black text-xl text-blue-900 hidden sm:block">أكاديمية م.جابر</span>
            </a>
            <nav class="hidden md:flex items-center gap-6 font-semibold">
                <a href="#" onclick="navigate('home')" class="nav-link hover:text-blue-600 transition">الرئيسية</a>
                <a href="#" onclick="navigate('courses')" class="nav-link hover:text-blue-600 transition">الدورات</a>
                <a href="#" onclick="navigate('settings')" class="nav-link hover:text-blue-600 transition">إعداداتي</a>
                <a href="#" onclick="navigate('admin')" class="nav-link admin-only hidden hover:text-blue-600 transition">لوحة التحكم</a>
            </nav>
            <div class="flex items-center gap-3">
                <!-- User info -->
                <div id="userProfile" class="hidden items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full">
                    <img id="userAvatar" src="" class="w-8 h-8 rounded-full border-2 border-blue-300">
                    <span id="userName" class="font-bold text-sm"></span>
                    <button onclick="logout()" class="text-red-500 text-xs mr-2"><i class="fas fa-sign-out-alt"></i></button>
                </div>
                <div id="authButtons" class="flex items-center gap-2">
                    <button onclick="openLoginModal()" class="px-5 py-2 rounded-full border-2 border-blue-600 text-blue-600 font-bold hover:bg-blue-600 hover:text-white transition">دخول</button>
                    <button onclick="openLoginModal()" class="px-5 py-2 rounded-full bg-blue-600 text-white font-bold shadow-lg">ابدأ</button>
                </div>
                <button id="menuToggle" onclick="toggleMobileMenu()" class="md:hidden p-2 rounded-lg bg-gray-100"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <!-- Mobile menu overlay -->
    <div id="mobileMenu" class="fixed inset-0 bg-white z-[60] hidden flex-col items-center justify-center gap-6 text-2xl font-bold">
        <button onclick="toggleMobileMenu()" class="absolute top-6 right-6 text-3xl">&times;</button>
        <a href="#" onclick="navigate('home'); toggleMobileMenu()">الرئيسية</a>
        <a href="#" onclick="navigate('courses'); toggleMobileMenu()">الدورات</a>
        <a href="#" onclick="navigate('settings'); toggleMobileMenu()">إعداداتي</a>
        <a href="#" onclick="navigate('admin'); toggleMobileMenu()" class="admin-only hidden">لوحة التحكم</a>
    </div>

    <!-- Login Modal (Google) -->
    <div id="loginModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-3xl max-w-md w-full p-8 relative">
            <button onclick="closeLoginModal()" class="absolute top-4 left-4 text-3xl text-gray-400">&times;</button>
            <div class="text-center">
                <i class="fas fa-user-graduate text-5xl text-blue-600 mb-4"></i>
                <h3 class="text-2xl font-black mb-2">تسجيل الدخول</h3>
                <p class="text-gray-500 mb-6">استخدم حساب جوجل للمتابعة</p>
                <div id="googleSignInBtn" class="flex justify-center"></div>
            </div>
        </div>
    </div>

    <!-- ========== الصفحات ========== -->
    <main class="pt-24 min-h-screen">
        <!-- الصفحة الرئيسية -->
        <section id="page-home" class="page active">
            <div class="hero-gradient bg-gradient-to-l from-blue-900 to-blue-600 text-white py-20 relative overflow-hidden">
                <div class="container mx-auto px-4 grid md:grid-cols-2 gap-10 items-center">
                    <div class="space-y-6">
                        <h1 class="text-5xl md:text-6xl font-black leading-tight">أتقن اللغة العربية <br> <span class="text-yellow-300">بأسلوب عصري</span></h1>
                        <p class="text-xl opacity-90">مع الأستاذ محمد جابر، نقدم لك تجربة تعليمية فريدة تجمع بين الأصالة والتكنولوجيا.</p>
                        <button onclick="navigate('courses')" class="bg-white text-blue-700 font-bold px-8 py-4 rounded-2xl shadow-xl hover:scale-105 transition">تصفح الكورسات</button>
                    </div>
                    <div class="flex justify-center">
                        <img src="https://placehold.co/600x400/1e3a8a/white?text=Mohamed+Jaber" class="rounded-3xl shadow-2xl float-anim">
                    </div>
                </div>
            </div>
            <!-- 10 ميزات -->
            <div class="py-20 bg-white">
                <div class="container mx-auto px-4">
                    <h2 class="text-4xl font-black text-center mb-16">لماذا أكاديميتنا؟ <span class="text-blue-600">10 ميزات حصرية</span></h2>
                    <div class="grid md:grid-cols-5 gap-6">
                        <div class="p-4 text-center"><i class="fas fa-video text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">دروس 4K</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-file-pdf text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">مذكرات PDF</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-tasks text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">اختبارات تفاعلية</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-certificate text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">شهادة إتمام</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-comments text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">تعليقات الطلاب</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-chart-line text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">تتبع التقدم</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-wallet text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">نظام نقاط</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-search text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">بحث متقدم</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-share-alt text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">مشاركة الكورسات</h4></div>
                        <div class="p-4 text-center"><i class="fas fa-gem text-3xl text-blue-600 mb-3"></i><h4 class="font-bold">متجر تعليمي</h4></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- صفحة الكورسات -->
        <section id="page-courses" class="page hidden">
            <div class="container mx-auto px-4 py-10">
                <h2 class="text-4xl font-black mb-4">جميع الكورسات</h2>
                <div class="flex gap-2 mb-8">
                    <button onclick="filterCourses('all')" class="filter-btn active px-6 py-2 bg-blue-600 text-white rounded-full font-bold">الكل</button>
                    <button onclick="filterCourses('first')" class="filter-btn px-6 py-2 bg-gray-200 rounded-full font-bold hover:bg-gray-300">الأول</button>
                    <button onclick="filterCourses('second')" class="filter-btn px-6 py-2 bg-gray-200 rounded-full font-bold hover:bg-gray-300">الثاني</button>
                    <button onclick="filterCourses('third')" class="filter-btn px-6 py-2 bg-gray-200 rounded-full font-bold hover:bg-gray-300">الثالث</button>
                </div>
                <div id="coursesContainer" class="grid md:grid-cols-3 gap-8"></div>
            </div>
        </section>

        <!-- صفحة تفاصيل الكورس -->
        <section id="page-course-detail" class="page hidden">
            <div class="container mx-auto px-4 py-10">
                <button onclick="navigate('courses')" class="mb-6 text-blue-600 font-bold"><i class="fas fa-arrow-right ml-2"></i>عودة</button>
                <div id="courseDetailContainer"></div>
            </div>
        </section>

        <!-- صفحة إعدادات الطالب -->
        <section id="page-settings" class="page hidden">
            <div class="container mx-auto px-4 py-10">
                <h2 class="text-4xl font-black mb-8">إعداداتي</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="col-span-2">
                        <div class="bg-white p-6 rounded-3xl shadow-md">
                            <h3 class="text-2xl font-bold mb-4">اشتراكاتي</h3>
                            <div id="userSubscriptions" class="space-y-4"></div>
                        </div>
                    </div>
                    <div>
                        <div class="bg-white p-6 rounded-3xl shadow-md">
                            <h3 class="text-2xl font-bold mb-4">بياناتي</h3>
                            <p id="profileEmail"></p>
                            <p id="profileName"></p>
                            <button onclick="logout()" class="mt-4 text-red-500">تسجيل خروج</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- صفحة لوحة التحكم (للأدمن فقط) -->
        <section id="page-admin" class="page hidden">
            <div class="container mx-auto px-4 py-10">
                <h2 class="text-4xl font-black mb-8">لوحة التحكم</h2>
                <div class="flex gap-2 mb-8 flex-wrap">
                    <button onclick="adminTab('courses')" class="admin-tab active" id="tabCourses">الكورسات</button>
                    <button onclick="adminTab('requests')" class="admin-tab" id="tabRequests">طلبات التفعيل</button>
                    <button onclick="adminTab('users')" class="admin-tab" id="tabUsers">المستخدمين</button>
                    <button onclick="adminTab('subscriptions')" class="admin-tab" id="tabSubs">الاشتراكات</button>
                </div>
                <div id="adminContent"></div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-blue-950 text-white py-12 mt-10">
        <div class="container mx-auto px-4 text-center">
            <p>© 2025 أكاديمية الأستاذ محمد جابر - جميع الحقوق محفوظة</p>
            <p class="text-blue-300 mt-2">تطوير بواسطة <span class="font-bold">براء عمر</span></p>
        </div>
    </footer>

    <script>
        // ================================
        // المتغيرات العامة
        // ================================
        let currentUser = null; // سيحتوي على بيانات المستخدم من Google (الاسم، البريد، الصورة)
        let currentUserRole = 'user'; // يتم تعيينها لاحقاً من Firestore
        const adminEmail = 'bo2584668@gmail.com';

        // ================================
        // Google Identity Services
        // ================================
        window.onload = function() {
            if (google && google.accounts) {
                google.accounts.id.initialize({
                    client_id: '583210084990-m5j5pkdp63s255aci47grhdhef5rfk9s.apps.googleusercontent.com',
                    callback: handleGoogleCredential,
                    auto_select: false,
                });
                google.accounts.id.renderButton(
                    document.getElementById('googleSignInBtn'),
                    { type: 'standard', theme: 'filled_blue', size: 'large', shape: 'pill', width: 250 }
                );
            }
        };

        async function handleGoogleCredential(response) {
            // فك تشفير JWT للحصول على بيانات المستخدم
            const data = parseJwt(response.credential);
            
            // إنشاء كائن المستخدم
            const user = {
                uid: data.sub,
                name: data.name,
                email: data.email,
                picture: data.picture,
            };
            
            // تخزين المستخدم في الجلسة الحالية
            currentUser = user;
            
            // حفظ/تحديث المستخدم في Firestore
            await saveUserToFirestore(user);
            
            // جلب دور المستخدم من Firestore
            await loadUserRole(user.uid);
            
            // تحديث واجهة المستخدم
            updateUIAfterLogin(user);
            
            closeLoginModal();
            
            Swal.fire({
                title: 'مرحباً ' + user.name,
                text: 'تم تسجيل الدخول بنجاح',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false
            });
        }

        // فك تشفير JWT
        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
            return JSON.parse(jsonPayload);
        }

        // حفظ المستخدم في Firestore (مجموعة users)
        async function saveUserToFirestore(user) {
            const userRef = doc(window.db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                // مستخدم جديد - نحدد الدور (admin إذا كان البريد هو الأدمن)
                const role = (user.email === adminEmail) ? 'admin' : 'user';
                await setDoc(userRef, {
                    name: user.name,
                    email: user.email,
                    photoURL: user.picture,
                    role: role,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString()
                });
            } else {
                // تحديث آخر ظهور
                await updateDoc(userRef, { lastLogin: new Date().toISOString() });
            }
        }

        // تحميل دور المستخدم من Firestore
        async function loadUserRole(uid) {
            const userRef = doc(window.db, 'users', uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                currentUserRole = userSnap.data().role || 'user';
            } else {
                currentUserRole = 'user';
            }
            // إظهار/إخفاء عناصر الأدمن
            if (currentUserRole === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            } else {
                document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            }
        }

        // تحديث واجهة المستخدم بعد تسجيل الدخول
        function updateUIAfterLogin(user) {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userProfile').classList.remove('hidden');
            document.getElementById('userAvatar').src = user.picture || 'https://via.placeholder.com/40';
            document.getElementById('userName').innerText = user.name;
        }

        // تسجيل الخروج (محلي فقط، لأننا لا نستخدم Firebase Auth)
        function logout() {
            currentUser = null;
            currentUserRole = 'user';
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userProfile').classList.add('hidden');
            document.querySelectorAll('.admin-only').forEach(el => el.classList.add('hidden'));
            // إلغاء الجلسة في Google (اختياري)
            if (google && google.accounts) {
                google.accounts.id.disableAutoSelect();
            }
            navigate('home');
            Swal.fire({
                title: 'تم تسجيل الخروج',
                icon: 'info',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // ================================
        // نظام التوجيه (SPA)
        // ================================
        function navigate(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            history.pushState({page}, '', `#${page}`);
            loadPageContent(page);
        }

        function getCurrentPage() {
            return window.location.hash.substring(1) || 'home';
        }

        window.addEventListener('popstate', (e) => {
            const page = e.state?.page || 'home';
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(`page-${page}`).classList.remove('hidden');
            loadPageContent(page);
        });

        async function loadPageContent(page) {
            if (page === 'courses') {
                loadCoursesList();
            } else if (page === 'admin' && currentUserRole === 'admin') {
                adminTab('courses');
            } else if (page === 'settings' && currentUser) {
                loadUserSettings();
            } else if (page === 'course-detail') {
                const courseId = sessionStorage.getItem('currentCourseId');
                if (courseId) loadCourseDetails(courseId);
            }
        }

        // ================================
        // عرض الكورسات
        // ================================
        async function loadCoursesList(grade = 'all') {
            const container = document.getElementById('coursesContainer');
            container.innerHTML = '<div class="col-span-3 text-center py-10">جاري التحميل...</div>';
            
            let q = collection(window.db, 'courses');
            if (grade !== 'all') {
                q = query(q, where('grade', '==', grade));
            }
            const querySnapshot = await getDocs(q);
            let html = '';
            querySnapshot.forEach(doc => {
                const course = { id: doc.id, ...doc.data() };
                html += `
                    <div class="course-card bg-white rounded-3xl overflow-hidden shadow-lg">
                        <img src="${course.image || 'https://placehold.co/600x400/3b82f6/white?text=Course'}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="text-2xl font-bold mb-2">${course.title}</h3>
                            <p class="text-gray-600 mb-4">${course.description || ''}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xl font-black text-blue-700">${course.price > 0 ? course.price + ' ج.م' : 'مجاني'}</span>
                                <button onclick="viewCourse('${course.id}')" class="px-4 py-2 bg-blue-600 text-white rounded-xl">عرض التفاصيل</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html || '<div class="col-span-3 text-center py-10">لا توجد كورسات</div>';
        }

        window.filterCourses = function(grade) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-600', 'text-white'));
            event.target.classList.add('active', 'bg-blue-600', 'text-white');
            loadCoursesList(grade);
        };

        window.viewCourse = function(courseId) {
            sessionStorage.setItem('currentCourseId', courseId);
            navigate('course-detail');
        };

        async function loadCourseDetails(courseId) {
            const container = document.getElementById('courseDetailContainer');
            container.innerHTML = '<p class="text-center">تحميل...</p>';
            
            const courseRef = doc(window.db, 'courses', courseId);
            const courseSnap = await getDoc(courseRef);
            if (!courseSnap.exists()) return;
            const course = { id: courseSnap.id, ...courseSnap.data() };
            
            // التحقق من صلاحية الوصول للمحتوى (إذا كان مسجل دخول ولديه اشتراك نشط أو الكورس مجاني)
            let canAccess = false;
            if (course.price === 0) canAccess = true;
            else if (currentUser) {
                const subsQuery = query(collection(window.db, 'subscriptions'), 
                    where('userId', '==', currentUser.uid), 
                    where('courseId', '==', courseId), 
                    where('status', '==', 'active'));
                const subsSnap = await getDocs(subsQuery);
                canAccess = !subsSnap.empty;
            }

            let videosHtml = '';
            if (course.videos && course.videos.length > 0) {
                videosHtml = course.videos.map((video, index) => `
                    <div class="border-b py-4">
                        <h4 class="font-bold mb-2">${index+1}. ${video.title}</h4>
                        ${canAccess ? `<iframe class="w-full h-64 rounded-xl" src="https://www.youtube.com/embed/${video.youtubeId}" frameborder="0" allowfullscreen></iframe>` : '<p class="text-red-500">هذا المحتوى متاح للمشتركين فقط</p>'}
                    </div>
                `).join('');
            } else {
                videosHtml = '<p>لا توجد فيديوهات بعد</p>';
            }

            let subscribeBtn = '';
            if (!canAccess && course.price > 0) {
                if (currentUser) {
                    subscribeBtn = `<button onclick="requestSubscription('${course.id}')" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold">طلب اشتراك</button>`;
                } else {
                    subscribeBtn = `<button onclick="openLoginModal()" class="px-6 py-3 bg-blue-600 text-white rounded-xl">سجل دخول أولاً</button>`;
                }
            }

            container.innerHTML = `
                <h1 class="text-4xl font-black mb-4">${course.title}</h1>
                <p class="text-gray-600 mb-6">${course.description}</p>
                <div class="mb-6">${subscribeBtn}</div>
                <div class="space-y-4">${videosHtml}</div>
            `;
        }

        // ================================
        // طلب اشتراك
        // ================================
        window.requestSubscription = async function(courseId) {
            if (!currentUser) return openLoginModal();
            
            const { value: formData } = await Swal.fire({
                title: 'طلب تفعيل اشتراك',
                html:
                    '<input id="swal-name" class="swal2-input" placeholder="الاسم الثلاثي" value="' + currentUser.name + '">' +
                    '<input id="swal-whatsapp" class="swal2-input" placeholder="رقم واتساب (مثال: 01012345678)">' +
                    '<input id="swal-phone" class="swal2-input" placeholder="رقم الهاتف (للتحويل)">',
                showCancelButton: true,
                confirmButtonText: 'إرسال الطلب',
                preConfirm: () => {
                    const name = document.getElementById('swal-name').value;
                    const whatsapp = document.getElementById('swal-whatsapp').value;
                    const phone = document.getElementById('swal-phone').value;
                    if (!name || !whatsapp || !phone) {
                        Swal.showValidationMessage('جميع الحقول مطلوبة');
                    }
                    return { name, whatsapp, phone };
                }
            });

            if (formData) {
                const request = {
                    userId: currentUser.uid,
                    userName: formData.name,
                    userWhatsapp: formData.whatsapp,
                    userPhone: formData.phone,
                    courseId: courseId,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                };
                await addDoc(collection(window.db, 'subscriptionRequests'), request);
                
                Swal.fire({
                    title: 'تم إرسال الطلب',
                    html: `يرجى التواصل عبر واتساب على الرقم <strong>+201273740256</strong> وإرسال صورة التحويل بعد الدفع.<br>رقمك: ${formData.whatsapp}`,
                    icon: 'success'
                });
            }
        };

        // ================================
        // إعدادات الطالب
        // ================================
        async function loadUserSettings() {
            document.getElementById('profileEmail').innerText = currentUser.email;
            document.getElementById('profileName').innerText = currentUser.name;

            const subsContainer = document.getElementById('userSubscriptions');
            const q = query(collection(window.db, 'subscriptions'), where('userId', '==', currentUser.uid));
            const subsSnap = await getDocs(q);
            if (subsSnap.empty) {
                subsContainer.innerHTML = '<p>لا توجد اشتراكات</p>';
                return;
            }
            let html = '';
            for (const docSub of subsSnap.docs) {
                const sub = docSub.data();
                const courseRef = doc(window.db, 'courses', sub.courseId);
                const courseSnap = await getDoc(courseRef);
                const courseTitle = courseSnap.exists() ? courseSnap.data().title : 'غير معروف';
                html += `
                    <div class="p-4 border rounded-2xl">
                        <p class="font-bold">${courseTitle}</p>
                        <p>الحالة: ${sub.status === 'active' ? 'نشط' : 'منتهي'}</p>
                        <p>تاريخ البدء: ${new Date(sub.startDate).toLocaleDateString('ar-EG')}</p>
                        <p>تاريخ الانتهاء: ${new Date(sub.endDate).toLocaleDateString('ar-EG')}</p>
                    </div>
                `;
            }
            subsContainer.innerHTML = html;
        }

        // ================================
        // لوحة تحكم الأدمن
        // ================================
        window.adminTab = function(tab) {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab${tab.charAt(0).toUpperCase()+tab.slice(1)}`).classList.add('active');
            if (tab === 'courses') renderAdminCourses();
            if (tab === 'requests') renderAdminRequests();
            if (tab === 'users') renderAdminUsers();
            if (tab === 'subscriptions') renderAdminSubscriptions();
        };

        async function renderAdminCourses() {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="mb-4">
                    <button onclick="showAddCourseModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl">+ إضافة كورس جديد</button>
                </div>
                <div id="adminCoursesList" class="grid gap-4"></div>
            `;
            const listDiv = document.getElementById('adminCoursesList');
            const q = query(collection(window.db, 'courses'), orderBy('createdAt', 'desc'));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const c = doc.data();
                html += `
                    <div class="bg-white p-4 rounded-xl flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-xl">${c.title}</h3>
                            <p>${c.price} ج.م - ${c.grade}</p>
                        </div>
                        <div>
                            <button onclick="editCourse('${doc.id}')" class="text-blue-600 ml-2"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteCourse('${doc.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            });
            listDiv.innerHTML = html || '<p>لا توجد كورسات</p>';
        }

        window.showAddCourseModal = function() {
            Swal.fire({
                title: 'إضافة كورس',
                html: `
                    <input id="course-title" class="swal2-input" placeholder="عنوان الكورس">
                    <textarea id="course-desc" class="swal2-input" placeholder="وصف"></textarea>
                    <input id="course-price" class="swal2-input" placeholder="السعر (0 مجاني)">
                    <select id="course-grade" class="swal2-input">
                        <option value="first">الأول</option>
                        <option value="second">الثاني</option>
                        <option value="third">الثالث</option>
                    </select>
                    <input id="course-image" class="swal2-input" placeholder="رابط صورة">
                `,
                showCancelButton: true,
                confirmButtonText: 'حفظ',
                preConfirm: async () => {
                    const title = document.getElementById('course-title').value;
                    const desc = document.getElementById('course-desc').value;
                    const price = parseFloat(document.getElementById('course-price').value) || 0;
                    const grade = document.getElementById('course-grade').value;
                    const image = document.getElementById('course-image').value || 'https://placehold.co/600x400/3b82f6/white?text=Course';
                    await addDoc(collection(window.db, 'courses'), {
                        title, description: desc, price, grade, image, 
                        createdAt: new Date().toISOString(), 
                        videos: [] // يمكن إضافتها لاحقاً
                    });
                    Swal.fire('تم', 'تمت إضافة الكورس', 'success');
                    renderAdminCourses();
                }
            });
        };

        window.deleteCourse = async function(id) {
            if (confirm('هل أنت متأكد؟')) {
                await deleteDoc(doc(window.db, 'courses', id));
                renderAdminCourses();
            }
        };

        window.editCourse = function(id) {
            // يمكن تنفيذ تعديل لاحقاً
            Swal.fire('ميزة التعديل', 'سيتم إضافتها قريباً', 'info');
        };

        // طلبات التفعيل
        async function renderAdminRequests() {
            const content = document.getElementById('adminContent');
            content.innerHTML = '<div id="requestsList"></div>';
            const listDiv = document.getElementById('requestsList');
            const q = query(collection(window.db, 'subscriptionRequests'), where('status', '==', 'pending'));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const r = doc.data();
                html += `
                    <div class="bg-white p-4 rounded-xl mb-4">
                        <p><strong>الاسم:</strong> ${r.userName}</p>
                        <p><strong>واتساب:</strong> ${r.userWhatsapp}</p>
                        <p><strong>هاتف:</strong> ${r.userPhone}</p>
                        <p><strong>معرف الكورس:</strong> ${r.courseId}</p>
                        <button onclick="acceptRequest('${doc.id}', '${r.userId}', '${r.courseId}')" class="px-4 py-2 bg-green-600 text-white rounded-xl ml-2">قبول</button>
                        <button onclick="rejectRequest('${doc.id}')" class="px-4 py-2 bg-red-600 text-white rounded-xl">رفض</button>
                    </div>
                `;
            });
            listDiv.innerHTML = html || '<p>لا توجد طلبات معلقة</p>';
        }

        window.acceptRequest = async function(requestId, userId, courseId) {
            const { value: duration } = await Swal.fire({
                title: 'اختر مدة الاشتراك',
                input: 'select',
                inputOptions: {
                    monthly: 'شهري (30 يوم)',
                    term: 'ترم (5 شهور)'
                },
                inputPlaceholder: 'اختر المدة',
                showCancelButton: true
            });
            if (duration) {
                const startDate = new Date();
                let endDate = new Date();
                if (duration === 'monthly') endDate.setMonth(endDate.getMonth() + 1);
                else endDate.setMonth(endDate.getMonth() + 5);

                await addDoc(collection(window.db, 'subscriptions'), {
                    userId,
                    courseId,
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    status: 'active',
                    type: duration
                });
                await updateDoc(doc(window.db, 'subscriptionRequests', requestId), { status: 'approved' });
                Swal.fire('تم', 'تم تفعيل الاشتراك', 'success');
                renderAdminRequests();
            }
        };

        window.rejectRequest = async function(requestId) {
            await updateDoc(doc(window.db, 'subscriptionRequests', requestId), { status: 'rejected' });
            renderAdminRequests();
        };

        async function renderAdminUsers() {
            // يمكن عرض المستخدمين من Firestore
            const content = document.getElementById('adminContent');
            content.innerHTML = '<p>قائمة المستخدمين (سيتم إضافتها قريباً)</p>';
        }

        async function renderAdminSubscriptions() {
            // عرض جميع الاشتراكات
            const content = document.getElementById('adminContent');
            content.innerHTML = '<p>جميع الاشتراكات (سيتم إضافتها قريباً)</p>';
        }

        // ================================
        // دوال مساعدة
        // ================================
        window.openLoginModal = () => document.getElementById('loginModal').classList.remove('hidden');
        window.closeLoginModal = () => document.getElementById('loginModal').classList.add('hidden');
        window.toggleMobileMenu = () => document.getElementById('mobileMenu').classList.toggle('hidden');
        window.navigate = navigate;

        // بدء التطبيق: تحديد الصفحة من الرابط
        (function init() {
            const page = getCurrentPage();
            navigate(page);
        })();
    </script>
</body>
</html>
