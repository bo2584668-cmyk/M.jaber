<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة الهيثم - الأستاذ هيثم رمضان</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: #f9f9f9; color: #333; line-height: 1.6; }
        .container { width: 90%; max-width: 1200px; margin: auto; }
        /* Header */
        header { background: #2c3e50; color: #fff; padding: 1rem 0; position: sticky; top:0; z-index:100; }
        header .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .logo h1 { font-size: 1.8rem; color: #f1c40f; }
        .logo span { font-size: 0.9rem; color: #ecf0f1; display: block; }
        nav ul { display: flex; list-style: none; gap: 1.5rem; }
        nav a { color: #fff; text-decoration: none; font-weight: 600; transition: color 0.3s; }
        nav a:hover { color: #f1c40f; }
        .auth-buttons button { background: #f1c40f; border: none; padding: 0.5rem 1.2rem; margin-right: 0.5rem; border-radius: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .auth-buttons button:hover { background: #d4ac0d; }
        .user-info { display: flex; align-items: center; gap: 1rem; color: #fff; }
        .user-info button { background: #e74c3c; color: #fff; border: none; padding: 0.3rem 1rem; border-radius: 5px; cursor: pointer; }
        /* Main content */
        .section { padding: 3rem 0; }
        .hero { background: linear-gradient(135deg, #34495e, #2c3e50); color: #fff; text-align: center; padding: 4rem 0; }
        .hero h2 { font-size: 2.5rem; margin-bottom: 1rem; }
        .hero p { font-size: 1.2rem; max-width: 700px; margin: auto; }
        .btn { display: inline-block; background: #f1c40f; color: #2c3e50; padding: 0.8rem 2rem; border-radius: 5px; text-decoration: none; font-weight: 700; margin-top: 1.5rem; border: none; cursor: pointer; }
        /* Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin-top: 2rem; }
        .card { background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .card-content { padding: 1.5rem; }
        .card h3 { margin-bottom: 1rem; color: #2c3e50; }
        .card p { color: #555; }
        /* Forms */
        .form-container { max-width: 500px; margin: 2rem auto; background: #fff; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        .form-group textarea { resize: vertical; min-height: 100px; }
        /* Table */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; background: #fff; border-collapse: collapse; margin-top: 1rem; }
        th, td { padding: 1rem; text-align: center; border-bottom: 1px solid #ddd; }
        th { background: #34495e; color: #fff; }
        tr:hover { background: #f5f5f5; }
        .badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.9rem; }
        .badge.pending { background: #f39c12; color: #fff; }
        .badge.active { background: #27ae60; color: #fff; }
        .badge.expired { background: #7f8c8d; color: #fff; }
        /* Lessons list */
        .lesson-group { margin-bottom: 2rem; }
        .lesson-group h3 { background: #ecf0f1; padding: 0.8rem; border-radius: 5px; margin-bottom: 1rem; }
        .lesson-item { background: #fff; padding: 1rem; margin-bottom: 0.5rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; border-right: 5px solid #f1c40f; }
        .lesson-item.locked { border-right-color: #95a5a6; opacity: 0.7; }
        .lesson-item .title { font-weight: 600; }
        .lesson-item .lock-icon { color: #e74c3c; }
        .lesson-item .free-icon { color: #27ae60; }
        .lesson-content { margin-top: 2rem; background: #fff; padding: 2rem; border-radius: 10px; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; margin-top: 1rem; }
        .video-wrapper iframe { position: absolute; top:0; left:0; width:100%; height:100%; border-radius:10px; }
        /* Subscription request */
        .request-form { background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin: 2rem 0; }
        .hidden { display: none; }
        /* Footer */
        footer { background: #2c3e50; color: #fff; padding: 2rem 0; margin-top: 3rem; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
        .footer-grid a { color: #bdc3c7; text-decoration: none; display: block; margin-bottom: 0.5rem; }
        .footer-grid a:hover { color: #f1c40f; }
        .copyright { text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #34495e; }
        .whatsapp-float { position: fixed; bottom: 20px; left: 20px; background: #25d366; color: #fff; width: 60px; height: 60px; border-radius: 50%; text-align: center; font-size: 30px; line-height: 60px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 100; }
        .whatsapp-float:hover { text-decoration: none; color: #fff; background: #20b954; }
        @media (max-width: 768px) { nav ul { display: none; } }
        /* admin panel */
        .admin-tabs { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .admin-tab { padding: 0.5rem 1.5rem; background: #ecf0f1; border-radius: 30px; cursor: pointer; font-weight: 600; }
        .admin-tab.active { background: #f1c40f; color: #2c3e50; }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        .countdown { font-size: 0.9rem; color: #27ae60; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <h1>منصة الهيثم</h1>
                <span>الأستاذ هيثم رمضان</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#" data-page="home">الرئيسية</a></li>
                    <li><a href="#" data-page="about">من نحن</a></li>
                    <li><a href="#" data-page="services">الخدمات</a></li>
                    <li><a href="#" data-page="what-we-offer">ماذا نقدم</a></li>
                    <li><a href="#" data-page="book">كتاب الهيثم</a></li>
                </ul>
            </nav>
            <div class="auth-buttons" id="authButtons">
                <button id="showLogin">تسجيل الدخول</button>
                <button id="showSignup">إنشاء حساب</button>
            </div>
            <div class="user-info hidden" id="userInfo">
                <span id="userName"></span>
                <span id="userGrade"></span>
                <span id="subscriptionStatus"></span>
                <button id="logoutBtn">تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area (Pages will be injected here) -->
    <main id="mainContent">
        <!-- Dynamic content loaded via JavaScript -->
    </main>

    <!-- WhatsApp Float -->
    <a href="https://wa.me/201025608740" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div>
                    <h3>الهيثم</h3>
                    <p>منصة تعليمية متخصصة في تدريس اللغة العربية بأحدث الطرق التفاعلية والمبتكرة</p>
                    <p>“قليل من الفهم خير من كثير من الحفظ”</p>
                </div>
                <div>
                    <h4>روابط سريعة</h4>
                    <a href="#" data-page="home">الرئيسية</a>
                    <a href="#" data-page="about">من نحن</a>
                    <a href="#" data-page="services">الدورات</a>
                    <a href="#" data-page="what-we-offer">الخدمات</a>
                </div>
                <div>
                    <h4>الدعم والمساعدة</h4>
                    <a href="#">مركز المساعدة</a>
                    <a href="#">الأسئلة الشائعة</a>
                    <a href="#">سياسة الخصوصية</a>
                    <a href="#">شروط الاستخدام</a>
                </div>
                <div>
                    <h4>تواصل معنا</h4>
                    <p>كفر الشيخ، مصر</p>
                    <p>01025608740</p>
                    <p>تابعنا على: <i class="fab fa-facebook"></i> <i class="fab fa-youtube"></i></p>
                </div>
            </div>
            <div class="copyright">
                <p>© 2026 منصة الهيثم. جميع الحقوق محفوظة. تم التطوير بواسطة Saad Elkammah</p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK (modular) -->
    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb",
            measurementId: "G-C7L0T2QHL8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Global variables
        let currentUser = null;
        let currentUserData = null;
        let currentPage = 'home';

        // DOM elements
        const main = document.getElementById('mainContent');
        const authButtons = document.getElementById('authButtons');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userGradeSpan = document.getElementById('userGrade');
        const subscriptionStatusSpan = document.getElementById('subscriptionStatus');

        // Navigation links
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.getAttribute('data-page');
                loadPage(page);
            });
        });

        // Auth buttons
        document.getElementById('showLogin').addEventListener('click', () => loadPage('login'));
        document.getElementById('showSignup').addEventListener('click', () => loadPage('signup'));
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            currentUser = null;
            currentUserData = null;
            loadPage('home');
        });

        // Listen to auth state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                currentUserData = userDoc.exists() ? userDoc.data() : null;
                // Update header
                authButtons.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                userNameSpan.textContent = currentUserData?.name || 'مستخدم';
                userGradeSpan.textContent = currentUserData?.grade || '';

                // Check subscription status
                const subQuery = query(collection(db, 'subscriptions'), where('userId', '==', user.uid), where('endDate', '>=', new Date()));
                const subSnap = await getDocs(subQuery);
                if (!subSnap.empty) {
                    const sub = subSnap.docs[0].data();
                    const daysLeft = Math.ceil((sub.endDate.toDate() - new Date()) / (1000*60*60*24));
                    subscriptionStatusSpan.innerHTML = `<span class="badge active">مشترك (${daysLeft} يوم)</span>`;
                } else {
                    subscriptionStatusSpan.innerHTML = `<span class="badge expired">غير مشترك</span>`;
                }

                // Reload current page with user context
                loadPage(currentPage);
            } else {
                currentUser = null;
                currentUserData = null;
                authButtons.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                loadPage(currentPage);
            }
        });

        // Load page function
        async function loadPage(page) {
            currentPage = page;
            // Hide all sections? We'll just render page content.
            if (page === 'home') renderHome();
            else if (page === 'about') renderAbout();
            else if (page === 'services') renderServices();
            else if (page === 'what-we-offer') renderWhatWeOffer();
            else if (page === 'book') renderBook();
            else if (page === 'login') renderLogin();
            else if (page === 'signup') renderSignup();
            else if (page === 'dashboard') renderDashboard();
            else if (page === 'admin') renderAdmin();
            else if (page === 'course') {
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('id');
                renderCourse(courseId);
            }
            else renderHome();
        }

        // ---------- Render Functions ----------
        function renderHome() {
            main.innerHTML = `
                <section class="hero">
                    <div class="container">
                        <h2>مرحباً بك في منصة الهيثم</h2>
                        <p>منصة مستر هيثم رمضان المتخصصة في اللغة العربية للأزهر الشريف</p>
                        <p>دروس تفاعلية | شهادات معتمدة | متابعة مستمرة</p>
                        <button class="btn" onclick="loadPage('services')">ابدأ الآن</button>
                    </div>
                </section>
                <section class="section">
                    <div class="container">
                        <h2>الدورات المتاحة</h2>
                        <div class="cards-grid" id="coursesGrid">
                            <!-- Courses will be loaded here -->
                        </div>
                    </div>
                </section>
            `;
            loadCourses();
        }

        async function loadCourses() {
            const coursesGrid = document.getElementById('coursesGrid');
            if (!coursesGrid) return;
            const coursesSnap = await getDocs(collection(db, 'courses'));
            let html = '';
            coursesSnap.forEach(doc => {
                const course = doc.data();
                html += `
                    <div class="card">
                        <div class="card-content">
                            <h3>${course.name}</h3>
                            <p>${course.description || ''}</p>
                            <button class="btn" onclick="loadPage('course?id=${doc.id}')">عرض المحتوى</button>
                        </div>
                    </div>
                `;
            });
            if (html === '') html = '<p>لا توجد دورات بعد</p>';
            coursesGrid.innerHTML = html;
        }

        function renderAbout() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>من نحن</h2>
                        <p>منصة استاذ هيثم رمضان لتدريس اللغة العربية. متخصص في تدريس مواد اللغة العربية عن بعد من أي مكان في جمهورية مصر العربية. خبرة أكثر من عشرين عاما في تدريس مواد اللغة العربية للمراحل الإعدادية والثانوية الأزهرية.</p>
                    </div>
                </section>
            `;
        }

        function renderServices() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>الخدمات</h2>
                        <p>نقدم بيئة تعليمية تفاعلية، محتوى متميز، اختبارات دورية، دعم مباشر، شهادات معتمدة، مرونة في التعلم.</p>
                    </div>
                </section>
            `;
        }

        function renderWhatWeOffer() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>ماذا نقدم</h2>
                        <div class="cards-grid">
                            <div class="card"><div class="card-content"><h3>بيئة تعليمية</h3><p>بيئة تعليمية تفاعلية متكاملة.</p></div></div>
                            <div class="card"><div class="card-content"><h3>محتوى تعليمي</h3><p>محتوى متميز يغطي جميع جوانب اللغة العربية.</p></div></div>
                            <div class="card"><div class="card-content"><h3>اختبارات دورية</h3><p>لتقييم مستوى الطلاب.</p></div></div>
                            <div class="card"><div class="card-content"><h3>دعم مباشر</h3><p>متابعة مستمرة.</p></div></div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderBook() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>كتاب الهيثم</h2>
                        <p>كتاب شامل ومتكامل لتعلم اللغة العربية بطريقة مبتكرة (خاص بالصف الثالث الثانوي).</p>
                        <p>للحجز والاستفسار: 01273740256</p>
                    </div>
                </section>
            `;
        }

        function renderLogin() {
            main.innerHTML = `
                <div class="form-container">
                    <h2>تسجيل الدخول</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn">تسجيل الدخول</button>
                    </form>
                    <p>ليس لديك حساب؟ <a href="#" onclick="loadPage('signup')">إنشاء حساب جديد</a></p>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    loadPage('dashboard');
                } catch (error) {
                    alert('خطأ في تسجيل الدخول: ' + error.message);
                }
            });
        }

        function renderSignup() {
            main.innerHTML = `
                <div class="form-container">
                    <h2>إنشاء حساب جديد</h2>
                    <form id="signupForm">
                        <div class="form-group">
                            <label>الاسم بالكامل</label>
                            <input type="text" id="signupName" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label>المحافظة</label>
                            <select id="signupGovernorate" required>
                                <option value="">اختر</option>
                                <option>القاهرة</option><option>الإسكندرية</option><option>كفر الشيخ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الصف الدراسي</label>
                            <select id="signupGrade" required>
                                <option value="">اختر</option>
                                <option>الأول الثانوي</option><option>الثاني الثانوي</option><option>الثالث الثانوي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>اسم المعهد</label>
                            <input type="text" id="signupInstitute" required>
                        </div>
                        <div class="form-group">
                            <label>تليفون الطالب</label>
                            <input type="tel" id="signupStudentPhone" required>
                        </div>
                        <div class="form-group">
                            <label>تليفون ولي الأمر</label>
                            <input type="tel" id="signupParentPhone" required>
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="signupPassword" required>
                        </div>
                        <div class="form-group">
                            <label>أعد كتابة كلمة المرور</label>
                            <input type="password" id="signupConfirmPassword" required>
                        </div>
                        <button type="submit" class="btn">إنشاء حساب</button>
                    </form>
                    <p>لديك حساب بالفعل؟ <a href="#" onclick="loadPage('login')">تسجيل الدخول</a></p>
                </div>
            `;
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const governorate = document.getElementById('signupGovernorate').value;
                const grade = document.getElementById('signupGrade').value;
                const institute = document.getElementById('signupInstitute').value;
                const studentPhone = document.getElementById('signupStudentPhone').value;
                const parentPhone = document.getElementById('signupParentPhone').value;
                const password = document.getElementById('signupPassword').value;
                const confirm = document.getElementById('signupConfirmPassword').value;
                if (password !== confirm) { alert('كلمة المرور غير متطابقة'); return; }
                try {
                    const userCred = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCred.user;
                    await setDoc(doc(db, 'users', user.uid), {
                        name, email, governorate, grade, institute, studentPhone, parentPhone, role: 'user', createdAt: new Date()
                    });
                    alert('تم إنشاء الحساب بنجاح');
                    loadPage('dashboard');
                } catch (error) {
                    alert('خطأ: ' + error.message);
                }
            });
        }

        function renderDashboard() {
            if (!currentUser) { loadPage('login'); return; }
            if (currentUser.email === 'bo2584668@gmail.com') {
                // Admin dashboard
                renderAdmin();
                return;
            }
            // Student dashboard: show courses based on grade
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>جميع الكورسات</h2>
                        <p>اختر الكورس المناسب لك وابدأ رحلتك التعليمية</p>
                        <div class="cards-grid" id="studentCoursesGrid"></div>
                    </div>
                </section>
            `;
            loadStudentCourses();
        }

        async function loadStudentCourses() {
            const grid = document.getElementById('studentCoursesGrid');
            if (!grid) return;
            const coursesSnap = await getDocs(collection(db, 'courses'));
            let html = '';
            coursesSnap.forEach(doc => {
                const course = doc.data();
                html += `
                    <div class="card">
                        <div class="card-content">
                            <h3>${course.name}</h3>
                            <button class="btn" onclick="loadPage('course?id=${doc.id}')">اضغط لعرض محتوى الكورس</button>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        async function renderCourse(courseId) {
            if (!courseId) { loadPage('dashboard'); return; }
            const courseDoc = await getDoc(doc(db, 'courses', courseId));
            if (!courseDoc.exists()) { loadPage('dashboard'); return; }
            const course = courseDoc.data();
            
            // Get lessons for this course
            const lessonsQuery = query(collection(db, 'lessons'), where('courseId', '==', courseId), orderBy('month', 'asc'), orderBy('order', 'asc'));
            const lessonsSnap = await getDocs(lessonsQuery);
            const lessons = [];
            lessonsSnap.forEach(d => lessons.push({ id: d.id, ...d.data() }));

            // Group by month
            const months = {};
            lessons.forEach(lesson => {
                const month = lesson.month || 'أخرى';
                if (!months[month]) months[month] = [];
                months[month].push(lesson);
            });

            // Check if user has active subscription
            let hasActiveSub = false;
            if (currentUser) {
                const subQuery = query(collection(db, 'subscriptions'), where('userId', '==', currentUser.uid), where('endDate', '>=', new Date()));
                const subSnap = await getDocs(subQuery);
                hasActiveSub = !subSnap.empty;
            }

            // Build HTML
            let lessonsHtml = '';
            for (let month in months) {
                lessonsHtml += `<div class="lesson-group"><h3>محتوي شهر ${month}</h3>`;
                months[month].forEach(lesson => {
                    const locked = lesson.paid && !hasActiveSub;
                    lessonsHtml += `
                        <div class="lesson-item ${locked ? 'locked' : ''}">
                            <span class="title">${lesson.title}</span>
                            ${locked ? '<span class="lock-icon"><i class="fas fa-lock"></i> محتوى مغلق- برجاء الاشتراك</span>' : '<span class="free-icon"><i class="fas fa-unlock"></i> متاح</span>'}
                            ${!locked ? `<button class="btn-small" onclick="viewLesson('${lesson.id}')">عرض</button>` : ''}
                        </div>
                    `;
                });
                lessonsHtml += '</div>';
            }

            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>كورس ${course.name}</h2>
                        ${!hasActiveSub ? renderSubscriptionRequest() : ''}
                        <div id="lessonList">
                            ${lessonsHtml}
                        </div>
                        <div id="lessonViewer" class="hidden"></div>
                    </div>
                </section>
            `;

            window.viewLesson = async (lessonId) => {
                const lessonDoc = await getDoc(doc(db, 'lessons', lessonId));
                if (!lessonDoc.exists()) return;
                const lesson = lessonDoc.data();
                const videoHtml = lesson.videoUrl ? 
                    (lesson.videoUrl.includes('youtube') ? 
                        `<div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${extractYoutubeId(lesson.videoUrl)}" frameborder="0" allowfullscreen></iframe></div>` 
                        : `<video controls><source src="${lesson.videoUrl}" type="video/mp4"></video>`) 
                    : '<p>لا يوجد فيديو</p>';
                document.getElementById('lessonViewer').innerHTML = `
                    <div class="lesson-content">
                        <h3>${lesson.title}</h3>
                        <p>${lesson.description}</p>
                        ${videoHtml}
                    </div>
                `;
                document.getElementById('lessonViewer').classList.remove('hidden');
                document.getElementById('lessonList').classList.add('hidden');
            };
        }

        function extractYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : '';
        }

        function renderSubscriptionRequest() {
            return `
                <div class="request-form">
                    <h3>تفعيل الاشتراك</h3>
                    <p>سعر الاشتراك: شهري 100 جنيه، ترم 300 جنيه</p>
                    <p>لتفعيل الاشتراك يرجي تحويل فودافون كاش علي الارقام: 01097841446 او 01033781752 او 01044768288</p>
                    <form id="subRequestForm">
                        <div class="form-group">
                            <label>نوع الاشتراك</label>
                            <select id="subType" required>
                                <option value="monthly">شهري (100 جنيه)</option>
                                <option value="semester">ترم (300 جنيه)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف المحول منه</label>
                            <input type="tel" id="subPhone" required>
                        </div>
                        <div class="form-group">
                            <label>صورة إيصال التحويل</label>
                            <input type="file" id="subReceipt" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn">تقديم طلب الاشتراك</button>
                    </form>
                </div>
            `;
            // Add submit listener after rendering
            setTimeout(() => {
                document.getElementById('subRequestForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUser) { alert('يجب تسجيل الدخول أولاً'); return; }
                    const type = document.getElementById('subType').value;
                    const phone = document.getElementById('subPhone').value;
                    const file = document.getElementById('subReceipt').files[0];
                    if (!file) { alert('اختر صورة الإيصال'); return; }
                    try {
                        // Upload image to Storage
                        const storageRef = ref(storage, `receipts/${currentUser.uid}_${Date.now()}.jpg`);
                        await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        // Create request in Firestore
                        await addDoc(collection(db, 'subscriptionRequests'), {
                            userId: currentUser.uid,
                            userName: currentUserData.name,
                            userGrade: currentUserData.grade,
                            type,
                            phone,
                            receiptUrl: url,
                            status: 'pending',
                            createdAt: new Date()
                        });
                        alert('تم تقديم الطلب بنجاح، سيتم مراجعته قريباً');
                    } catch (error) {
                        alert('خطأ: ' + error.message);
                    }
                });
            }, 100);
        }

        // Admin Panel
        async function renderAdmin() {
            if (!currentUser || currentUser.email !== 'bo2584668@gmail.com') { loadPage('home'); return; }
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2>لوحة التحكم - الأدمن</h2>
                        <div class="admin-tabs">
                            <div class="admin-tab active" data-admin-tab="requests">طلبات الاشتراك</div>
                            <div class="admin-tab" data-admin-tab="lessons">إدارة الدروس</div>
                            <div class="admin-tab" data-admin-tab="courses">إدارة الكورسات</div>
                        </div>
                        <div id="adminRequests" class="admin-section active">
                            <h3>طلبات الاشتراك</h3>
                            <div class="table-responsive">
                                <table id="requestsTable">
                                    <thead><tr><th>الطالب</th><th>الصف</th><th>النوع</th><th>الهاتف</th><th>الإيصال</th><th>الحالة</th><th>إجراء</th></tr></thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="adminLessons" class="admin-section">
                            <h3>إضافة درس جديد</h3>
                            <form id="addLessonForm">
                                <div class="form-group">
                                    <label>اختر الكورس</label>
                                    <select id="lessonCourse" required></select>
                                </div>
                                <div class="form-group">
                                    <label>الشهر</label>
                                    <select id="lessonMonth" required>
                                        <option value="يناير">يناير</option><option value="فبراير">فبراير</option><option value="مارس">مارس</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>عنوان الدرس</label>
                                    <input type="text" id="lessonTitle" required>
                                </div>
                                <div class="form-group">
                                    <label>وصف الدرس</label>
                                    <textarea id="lessonDesc" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label>رابط يوتيوب أو فيديو</label>
                                    <input type="text" id="lessonVideo" placeholder="https://youtu.be/...">
                                    <small>أو ارفع ملف فيديو</small>
                                    <input type="file" id="lessonVideoFile" accept="video/*">
                                </div>
                                <div class="form-group">
                                    <label>صورة مصغرة</label>
                                    <input type="file" id="lessonThumb" accept="image/*">
                                </div>
                                <div class="form-group">
                                    <label>مدفوع؟</label>
                                    <input type="checkbox" id="lessonPaid"> نعم
                                </div>
                                <button type="submit" class="btn">نشر الدرس</button>
                            </form>
                            <hr>
                            <h3>الدروس الموجودة</h3>
                            <div id="lessonsList"></div>
                        </div>
                        <div id="adminCourses" class="admin-section">
                            <h3>إضافة كورس جديد</h3>
                            <form id="addCourseForm">
                                <div class="form-group">
                                    <label>اسم الكورس</label>
                                    <input type="text" id="courseName" required>
                                </div>
                                <div class="form-group">
                                    <label>وصف الكورس</label>
                                    <textarea id="courseDesc" required></textarea>
                                </div>
                                <div class="form-group">
                                    <label>الصف</label>
                                    <input type="text" id="courseGrade" required>
                                </div>
                                <button type="submit" class="btn">إضافة كورس</button>
                            </form>
                        </div>
                    </div>
                </section>
            `;

            // Tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                    document.getElementById('admin' + tab.dataset.adminTab.charAt(0).toUpperCase() + tab.dataset.adminTab.slice(1)).classList.add('active');
                });
            });

            // Load requests
            loadRequests();

            // Load courses for select
            loadCoursesSelect();

            // Load lessons list
            loadLessonsList();

            // Add lesson form
            document.getElementById('addLessonForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const courseId = document.getElementById('lessonCourse').value;
                const month = document.getElementById('lessonMonth').value;
                const title = document.getElementById('lessonTitle').value;
                const desc = document.getElementById('lessonDesc').value;
                const videoUrl = document.getElementById('lessonVideo').value;
                const videoFile = document.getElementById('lessonVideoFile').files[0];
                const thumbFile = document.getElementById('lessonThumb').files[0];
                const paid = document.getElementById('lessonPaid').checked;

                let finalVideoUrl = videoUrl;
                if (videoFile) {
                    const storageRef = ref(storage, `videos/${Date.now()}_${videoFile.name}`);
                    await uploadBytes(storageRef, videoFile);
                    finalVideoUrl = await getDownloadURL(storageRef);
                }

                let thumbUrl = '';
                if (thumbFile) {
                    const thumbRef = ref(storage, `thumbs/${Date.now()}_${thumbFile.name}`);
                    await uploadBytes(thumbRef, thumbFile);
                    thumbUrl = await getDownloadURL(thumbRef);
                }

                await addDoc(collection(db, 'lessons'), {
                    courseId,
                    month,
                    title,
                    description: desc,
                    videoUrl: finalVideoUrl,
                    thumbUrl,
                    paid,
                    order: Date.now(),
                    createdAt: new Date()
                });
                alert('تم إضافة الدرس');
                loadLessonsList();
            });

            // Add course form
            document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('courseName').value;
                const desc = document.getElementById('courseDesc').value;
                const grade = document.getElementById('courseGrade').value;
                await addDoc(collection(db, 'courses'), { name, description: desc, grade });
                alert('تم إضافة الكورس');
                loadCoursesSelect();
            });
        }

        async function loadRequests() {
            const tbody = document.querySelector('#requestsTable tbody');
            if (!tbody) return;
            const requestsSnap = await getDocs(collection(db, 'subscriptionRequests'));
            tbody.innerHTML = '';
            requestsSnap.forEach(doc => {
                const req = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${req.userName}</td>
                    <td>${req.userGrade}</td>
                    <td>${req.type === 'monthly' ? 'شهري' : 'ترم'}</td>
                    <td>${req.phone}</td>
                    <td><a href="${req.receiptUrl}" target="_blank">عرض</a></td>
                    <td><span class="badge pending">${req.status}</span></td>
                    <td>
                        ${req.status === 'pending' ? `<button class="btn-small" onclick="approveRequest('${doc.id}', '${req.userId}', '${req.type}')">تفعيل</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            window.approveRequest = async (reqId, userId, type) => {
                const now = new Date();
                const endDate = new Date(now);
                if (type === 'monthly') endDate.setDate(now.getDate() + 30);
                else endDate.setMonth(now.getMonth() + 5);
                await addDoc(collection(db, 'subscriptions'), {
                    userId,
                    type,
                    startDate: now,
                    endDate: endDate,
                    createdAt: now
                });
                await updateDoc(doc(db, 'subscriptionRequests', reqId), { status: 'approved' });
                alert('تم تفعيل الاشتراك');
                loadRequests();
            };
        }

        async function loadCoursesSelect() {
            const select = document.getElementById('lessonCourse');
            if (!select) return;
            const coursesSnap = await getDocs(collection(db, 'courses'));
            select.innerHTML = '';
            coursesSnap.forEach(doc => {
                select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
        }

        async function loadLessonsList() {
            const div = document.getElementById('lessonsList');
            if (!div) return;
            const lessonsSnap = await getDocs(collection(db, 'lessons'));
            let html = '<ul>';
            lessonsSnap.forEach(doc => {
                const lesson = doc.data();
                html += `<li>${lesson.title} - ${lesson.month} <button onclick="deleteLesson('${doc.id}')">حذف</button></li>`;
            });
            html += '</ul>';
            div.innerHTML = html;
            window.deleteLesson = async (id) => {
                if (confirm('متأكد؟')) {
                    await deleteDoc(doc(db, 'lessons', id));
                    loadLessonsList();
                }
            };
        }

        // Initialize with home page
        loadPage('home');

        // Expose loadPage globally
        window.loadPage = loadPage;
    </script>
</body>
</html>
