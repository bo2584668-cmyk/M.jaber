<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>منصة محمد جابر | الأستاذ محمد جابر</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts (Cairo) -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        /* ========== المتغيرات والأساسيات ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }
        body {
            background: #f0f2f5;
            color: #2c3e50;
            line-height: 1.6;
            overflow-x: hidden;
        }
        :root {
            --primary: #1e2a3a;
            --secondary: #c9a959;
            --accent: #d4af37;
            --light: #f8f9fa;
            --dark: #0f172a;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --info: #3498db;
            --gradient: linear-gradient(135deg, #1e2a3a 0%, #2c3e50 100%);
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --shadow-hover: 0 15px 40px rgba(0,0,0,0.2);
            --transition: all 0.3s ease;
        }
        .container {
            width: 90%;
            max-width: 1300px;
            margin: 0 auto;
            padding: 0 15px;
        }
        /* ========== Toast Notifications ========== */
        .toast-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background: white;
            color: #2c3e50;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            transform: translateX(120%);
            animation: slideInLeft 0.3s forwards, fadeOut 0.5s 4.5s forwards;
            border-right: 5px solid var(--secondary);
        }
        .toast.success { border-right-color: var(--success); }
        .toast.error { border-right-color: var(--danger); }
        .toast.warning { border-right-color: var(--warning); }
        .toast.info { border-right-color: var(--info); }
        .toast i { font-size: 1.2rem; }
        @keyframes slideInLeft {
            to { transform: translateX(0); }
        }
        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(120%); }
        }
        /* ========== Header ========== */
        header {
            background: var(--gradient);
            color: white;
            padding: 0.8rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid var(--accent);
            object-fit: cover;
            background: white;
        }
        .logo h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #f1c40f, #d4af37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .logo span {
            display: block;
            font-size: 0.9rem;
            color: #bdc3c7;
            margin-top: -5px;
        }
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.8rem;
            flex-wrap: wrap;
        }
        nav a {
            color: white;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            position: relative;
            padding: 0.5rem 0;
            white-space: nowrap;
        }
        nav a:hover {
            color: var(--accent);
        }
        nav a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--accent);
            transition: var(--transition);
        }
        nav a:hover::after {
            width: 100%;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .auth-buttons button {
            background: var(--accent);
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .auth-buttons button:hover {
            background: #e6c200;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1.2rem;
            border-radius: 50px;
            backdrop-filter: blur(5px);
            flex-wrap: wrap;
        }
        .user-info span {
            font-weight: 600;
        }
        .user-info .role-badge {
            background: var(--accent);
            color: var(--dark);
            padding: 0.2rem 1rem;
            border-radius: 50px;
            font-size: 0.8rem;
        }
        .user-info button {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.3rem 1rem;
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
        }
        .user-info button:hover {
            background: #c0392b;
        }
        .hidden { display: none !important; }

        /* ========== Hero Section ========== */
        .hero {
            background: linear-gradient(135deg, rgba(30,42,58,0.95), rgba(44,62,80,0.95)), url('https://images.unsplash.com/photo-1503676260728-51780f9c5f5e?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80') center/cover fixed;
            color: white;
            text-align: center;
            padding: 6rem 0;
            position: relative;
            overflow: hidden;
        }
        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
        }
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .hero h2 {
            font-size: clamp(2rem, 5vw, 3.5rem);
            margin-bottom: 1rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .hero p {
            font-size: clamp(1rem, 3vw, 1.4rem);
            max-width: 800px;
            margin: 0 auto 2rem;
            opacity: 0.9;
        }
        .hero .btn {
            background: var(--accent);
            color: var(--dark);
            padding: 1rem 3rem;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1.2rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: var(--transition);
            border: 2px solid var(--accent);
        }
        .hero .btn:hover {
            background: transparent;
            color: white;
            border-color: white;
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
        }

        /* ========== Cards ========== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }
        .card {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            top: 0;
        }
        .card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-hover);
        }
        .card-img {
            height: 200px;
            background-size: cover;
            background-position: center;
        }
        .card-content {
            padding: 2rem;
        }
        .card h3 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1rem;
            font-weight: 700;
        }
        .card p {
            color: #555;
            margin-bottom: 1.5rem;
        }
        .btn-card {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }
        .btn-card:hover {
            background: linear-gradient(135deg, #2c3e50, #1e2a3a);
            letter-spacing: 1px;
        }

        /* ========== Forms ========== */
        .form-container {
            max-width: 600px;
            margin: 3rem auto;
            background: white;
            padding: clamp(1.5rem, 5vw, 3rem);
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .form-container h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary);
            font-weight: 800;
            position: relative;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
        }
        .form-container h2::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: var(--accent);
            margin: 1rem auto 0;
            border-radius: 2px;
        }
        .form-group {
            margin-bottom: 1.8rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-size: 1rem;
            transition: var(--transition);
            background: #f9f9f9;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
        }
        .form-group input[type="file"] {
            padding: 0.8rem;
            border-radius: 30px;
        }
        .btn-submit {
            background: var(--gradient);
            color: white;
            width: 100%;
            padding: 1.2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 1rem;
        }
        .btn-submit:hover {
            background: linear-gradient(135deg, #2c3e50, #1e2a3a);
            transform: scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* ========== Dashboard ========== */
        .dashboard-header {
            background: linear-gradient(135deg, #1e2a3a, #2c3e50);
            color: white;
            padding: 2rem 0;
            margin-bottom: 3rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
        }
        .stat-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .stat-card i {
            font-size: 3rem;
            color: var(--accent);
            margin-bottom: 1rem;
        }
        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        /* ========== Lessons ========== */
        .lesson-group {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
        }
        .lesson-group h3 {
            color: var(--primary);
            font-size: 1.8rem;
            border-bottom: 2px solid var(--accent);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .lesson-item {
            background: #f8f9fa;
            padding: 1.2rem 2rem;
            margin-bottom: 0.8rem;
            border-radius: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-right: 5px solid var(--accent);
            flex-wrap: wrap;
            gap: 10px;
        }
        .lesson-item.locked {
            border-right-color: #95a5a6;
            opacity: 0.7;
            background: #ecf0f1;
        }
        .lesson-item .title {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .lesson-item .lock-icon {
            color: var(--danger);
        }
        .lesson-item .free-icon {
            color: var(--success);
        }
        .btn-small {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 30px;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-small:hover {
            background: var(--accent);
            color: var(--dark);
        }

        /* ========== Admin Tabs ========== */
        .admin-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .admin-tab {
            padding: 0.8rem 2rem;
            background: white;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 700;
            transition: var(--transition);
            box-shadow: var(--shadow);
        }
        .admin-tab.active {
            background: var(--accent);
            color: var(--dark);
            transform: scale(1.05);
        }
        .admin-section {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 30px;
            box-shadow: var(--shadow);
        }
        .admin-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== Table ========== */
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 20px;
            overflow: hidden;
        }
        th {
            background: var(--primary);
            color: white;
            padding: 1rem;
        }
        td {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:hover td {
            background: #f5f5f5;
        }

        /* ========== Footer ========== */
        footer {
            background: var(--dark);
            color: white;
            padding: 3rem 0 1rem;
            margin-top: 4rem;
        }
        .footer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        .footer-grid a {
            color: #bdc3c7;
            text-decoration: none;
            display: block;
            margin-bottom: 0.5rem;
            transition: var(--transition);
        }
        .footer-grid a:hover {
            color: var(--accent);
            padding-right: 5px;
        }
        .copyright {
            text-align: center;
            padding-top: 2rem;
            border-top: 1px solid #34495e;
            color: #95a5a6;
        }
        .whatsapp-float {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: #25d366;
            color: white;
            width: 65px;
            height: 65px;
            border-radius: 50%;
            text-align: center;
            font-size: 35px;
            line-height: 65px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 100;
            transition: var(--transition);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(37, 211, 102, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 211, 102, 0); }
        }
        .whatsapp-float:hover {
            background: #20b954;
            transform: scale(1.1) rotate(10deg);
        }
        .badge {
            padding: 0.3rem 1rem;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .badge.pending { background: #f39c12; color: white; }
        .badge.active { background: #27ae60; color: white; }
        .badge.expired { background: #7f8c8d; color: white; }
        .badge.admin { background: #8e44ad; color: white; }
        .badge.user { background: #3498db; color: white; }

        /* Responsive */
        @media (max-width: 768px) {
            header .container {
                flex-direction: column;
                align-items: stretch;
            }
            nav ul {
                justify-content: center;
            }
            .auth-buttons {
                justify-content: center;
            }
            .user-info {
                justify-content: center;
            }
            .lesson-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .lesson-item .btn-small {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <img src="mrjabr.png" alt="الأستاذ محمد جابر" onerror="this.src='https://via.placeholder.com/60?text=Jaber'">
                <div>
                    <h1>منصة محمد جابر</h1>
                    <span>الأستاذ محمد جابر</span>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="#" data-page="home">الرئيسية</a></li>
                    <li><a href="#" data-page="about">من نحن</a></li>
                    <li><a href="#" data-page="services">الخدمات</a></li>
                    <li><a href="#" data-page="what-we-offer">ماذا نقدم</a></li>
                    <li><a href="#" data-page="book">كتاب الجابر</a></li>
                    <li><a href="#" data-page="mycourses" class="mycourses-link hidden" id="mycoursesLink">كورساتي</a></li>
                </ul>
            </nav>
            <div class="auth-buttons" id="authButtons">
                <button id="showLogin"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
                <button id="showSignup"><i class="fas fa-user-plus"></i> إنشاء حساب</button>
            </div>
            <div class="user-info hidden" id="userInfo">
                <i class="fas fa-user-circle fa-2x"></i>
                <span id="userName"></span>
                <span class="role-badge" id="userRole"></span>
                <span id="subscriptionStatus"></span>
                <button id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="mainContent"></main>

    <!-- WhatsApp Float -->
    <a href="https://wa.me/201273740256" class="whatsapp-float" target="_blank"><i class="fab fa-whatsapp"></i></a>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-grid">
                <div>
                    <h3><i class="fas fa-graduation-cap"></i> منصة محمد جابر</h3>
                    <p>المنصة الأولى لتعليم اللغة العربية بطريقة مبتكرة مع الأستاذ محمد جابر</p>
                    <p class="quote">"قليل من الفهم خير من كثير من الحفظ"</p>
                </div>
                <div>
                    <h4>روابط سريعة</h4>
                    <a href="#" data-page="home"><i class="fas fa-home"></i> الرئيسية</a>
                    <a href="#" data-page="about"><i class="fas fa-info-circle"></i> من نحن</a>
                    <a href="#" data-page="services"><i class="fas fa-cogs"></i> الخدمات</a>
                    <a href="#" data-page="what-we-offer"><i class="fas fa-gift"></i> ماذا نقدم</a>
                    <a href="#" data-page="book"><i class="fas fa-book"></i> كتاب الجابر</a>
                    <a href="#" data-page="mycourses" id="footerMycourses" class="hidden"><i class="fas fa-play-circle"></i> كورساتي</a>
                </div>
                <div>
                    <h4>الدعم والمساعدة</h4>
                    <a href="#"><i class="fas fa-question-circle"></i> مركز المساعدة</a>
                    <a href="#"><i class="fas fa-comments"></i> الأسئلة الشائعة</a>
                    <a href="#"><i class="fas fa-shield-alt"></i> سياسة الخصوصية</a>
                    <a href="#"><i class="fas fa-file-contract"></i> شروط الاستخدام</a>
                </div>
                <div>
                    <h4>تواصل معنا</h4>
                    <p><i class="fas fa-map-marker-alt"></i> المحلة الكبرى، مصر</p>
                    <p><i class="fas fa-phone-alt"></i> 01273740256</p>
                    <div style="font-size: 1.5rem; margin-top: 1rem;">
                        <i class="fab fa-facebook-square"></i>
                        <i class="fab fa-youtube"></i>
                        <i class="fab fa-twitter"></i>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>© 2026 منصة محمد جابر. جميع الحقوق محفوظة. تم التطوير بواسطة <strong>براء عمر</strong></p>
            </div>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script type="module">
        // ========== Firebase Imports ==========
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, where, orderBy, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        // ========== Firebase Config ==========
        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb",
            measurementId: "G-C7L0T2QHL8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // ========== Global Variables ==========
        let currentUser = null;
        let currentUserData = null;
        let currentPage = 'home';

        // DOM Elements
        const main = document.getElementById('mainContent');
        const authButtons = document.getElementById('authButtons');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userRoleSpan = document.getElementById('userRole');
        const subscriptionStatusSpan = document.getElementById('subscriptionStatus');
        const toastContainer = document.getElementById('toastContainer');
        const mycoursesLink = document.getElementById('mycoursesLink');
        const footerMycourses = document.getElementById('footerMycourses');

        // ========== Toast Function ==========
        function showToast(message, type = 'info', icon = 'fa-info-circle') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // ========== Navigation ==========
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = e.target.closest('a').getAttribute('data-page');
                loadPage(page);
            });
        });

        document.getElementById('showLogin').addEventListener('click', () => loadPage('login'));
        document.getElementById('showSignup').addEventListener('click', () => loadPage('signup'));
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            showToast('تم تسجيل الخروج بنجاح', 'success', 'fa-check-circle');
            loadPage('home');
        });

        // ========== Auth State Listener ==========
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                } else {
                    // إنشاء مستند إذا لم يكن موجوداً (للطوارئ)
                    currentUserData = { role: 'user', name: user.email };
                    await setDoc(doc(db, 'users', user.uid), currentUserData);
                }
                // تحديث الهيدر
                authButtons.classList.add('hidden');
                userInfoDiv.classList.remove('hidden');
                userNameSpan.textContent = currentUserData.name || 'مستخدم';
                userRoleSpan.textContent = currentUserData.role === 'admin' ? 'أدمن' : 'طالب';
                
                // إظهار رابط كورساتي للطلاب
                if (currentUserData.role === 'user') {
                    mycoursesLink.classList.remove('hidden');
                    footerMycourses.classList.remove('hidden');
                } else {
                    mycoursesLink.classList.add('hidden');
                    footerMycourses.classList.add('hidden');
                }
                
                // التحقق من الاشتراك
                const subQuery = query(collection(db, 'subscriptions'), where('userId', '==', user.uid), where('endDate', '>=', new Date()));
                const subSnap = await getDocs(subQuery);
                if (!subSnap.empty) {
                    const sub = subSnap.docs[0].data();
                    const endDate = sub.endDate.toDate();
                    const daysLeft = Math.ceil((endDate - new Date()) / (1000*60*60*24));
                    subscriptionStatusSpan.innerHTML = `<span class="badge active">مشترك (${daysLeft} يوم)</span>`;
                } else {
                    subscriptionStatusSpan.innerHTML = `<span class="badge expired">غير مشترك</span>`;
                }

                // إذا كان المستخدم في صفحة تسجيل الدخول أو إنشاء حساب، نوجهه للوحة التحكم
                if (currentPage === 'login' || currentPage === 'signup') {
                    loadPage('dashboard');
                } else {
                    loadPage(currentPage);
                }
            } else {
                currentUser = null;
                currentUserData = null;
                authButtons.classList.remove('hidden');
                userInfoDiv.classList.add('hidden');
                mycoursesLink.classList.add('hidden');
                footerMycourses.classList.add('hidden');
                loadPage(currentPage);
            }
        });

        // ========== Page Loader ==========
        async function loadPage(page) {
            currentPage = page;
            if (page === 'home') renderHome();
            else if (page === 'about') renderAbout();
            else if (page === 'services') renderServices();
            else if (page === 'what-we-offer') renderWhatWeOffer();
            else if (page === 'book') renderBook();
            else if (page === 'login') renderLogin();
            else if (page === 'signup') renderSignup();
            else if (page === 'dashboard') renderDashboard();
            else if (page === 'mycourses') renderMyCourses();
            else if (page === 'admin') renderAdmin();
            else if (page.startsWith('course?id=')) {
                const courseId = page.split('=')[1];
                renderCourse(courseId);
            }
            else renderHome();
        }

        // ========== Render Functions ==========
        function renderHome() {
            main.innerHTML = `
                <section class="hero">
                    <div class="container">
                        <h2 class="animate__animated animate__fadeInDown">مرحباً بك في منصة محمد جابر</h2>
                        <p class="animate__animated animate__fadeInUp">مع الأستاذ محمد جابر، رحلتك نحو التميز في اللغة العربية تبدأ من هنا</p>
                        <button class="btn animate__animated animate__zoomIn" onclick="loadPage('services')"><i class="fas fa-play"></i> ابدأ الآن</button>
                    </div>
                </section>
                <section class="section">
                    <div class="container">
                        <h2 style="text-align: center; font-size: clamp(2rem, 5vw, 2.5rem); margin-bottom: 2rem;">الدورات المتاحة</h2>
                        <div class="cards-grid" id="coursesGrid"></div>
                    </div>
                </section>
            `;
            loadCourses();
        }

        async function loadCourses() {
            const grid = document.getElementById('coursesGrid');
            if (!grid) return;
            const coursesSnap = await getDocs(collection(db, 'courses'));
            if (coursesSnap.empty) {
                grid.innerHTML = '<p class="text-center">لا توجد دورات بعد</p>';
                return;
            }
            let html = '';
            coursesSnap.forEach(doc => {
                const course = doc.data();
                html += `
                    <div class="card animate__animated animate__fadeInUp">
                        <div class="card-img" style="background-image: url('https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80');"></div>
                        <div class="card-content">
                            <h3>${course.name}</h3>
                            <p>${course.description || 'شرح مبسط وممتع'}</p>
                            <button class="btn-card" onclick="loadPage('course?id=${doc.id}')">عرض المحتوى</button>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        function renderAbout() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2 style="text-align: center; font-size: clamp(2rem, 5vw, 2.5rem);">من نحن</h2>
                        <div style="display: flex; gap: 3rem; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <img src="mrjabr.png" alt="الأستاذ محمد جابر" style="width: 100%; border-radius: 30px; box-shadow: var(--shadow);">
                            </div>
                            <div style="flex: 2;">
                                <p style="font-size: 1.2rem; line-height: 1.8;">منصة الأستاذ محمد جابر لتدريس اللغة العربية. متخصص في تدريس مواد اللغة العربية عن بعد من أي مكان في جمهورية مصر العربية. خبرة أكثر من عشرين عاماً في تدريس مواد اللغة العربية للمراحل الإعدادية والثانوية.</p>
                                <p style="font-size: 1.2rem; margin-top: 1rem;">نقدم تعليماً متميزاً يجمع بين الأصالة والتقنيات الحديثة.</p>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderServices() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2 style="text-align: center; font-size: clamp(2rem, 5vw, 2.5rem);">خدماتنا</h2>
                        <div class="cards-grid">
                            <div class="card"><div class="card-content"><i class="fas fa-chalkboard-teacher fa-3x" style="color: var(--accent);"></i><h3>دروس تفاعلية</h3><p>شروحات حية ومسجلة بأحدث الأساليب.</p></div></div>
                            <div class="card"><div class="card-content"><i class="fas fa-file-alt fa-3x" style="color: var(--accent);"></i><h3>اختبارات دورية</h3><p>تقييم مستمر لمستوى التقدم.</p></div></div>
                            <div class="card"><div class="card-content"><i class="fas fa-headset fa-3x" style="color: var(--accent);"></i><h3>دعم فني 24/7</h3><p>فريق متخصص للإجابة عن استفساراتك.</p></div></div>
                            <div class="card"><div class="card-content"><i class="fas fa-certificate fa-3x" style="color: var(--accent);"></i><h3>شهادات معتمدة</h3><p>احصل على شهادة بعد إتمام الدورة.</p></div></div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderWhatWeOffer() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2 style="text-align: center; font-size: clamp(2rem, 5vw, 2.5rem);">ماذا نقدم</h2>
                        <div class="cards-grid">
                            <div class="card"><div class="card-content"><h3>بيئة تعليمية</h3><p>بيئة تفاعلية متكاملة تجمع بين التعليم التقليدي والتقنيات الحديثة.</p></div></div>
                            <div class="card"><div class="card-content"><h3>محتوى تعليمي</h3><p>محتوى متميز يغطي جميع فروع اللغة العربية.</p></div></div>
                            <div class="card"><div class="card-content"><h3>اختبارات دورية</h3><p>لتقييم مستوى الطلاب ومتابعة تقدمهم.</p></div></div>
                            <div class="card"><div class="card-content"><h3>دعم مباشر</h3><p>متابعة مستمرة من فريق متخصص.</p></div></div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderBook() {
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <div style="display: flex; gap: 3rem; align-items: center; flex-wrap: wrap;">
                            <div style="flex: 1;">
                                <img src="https://images.unsplash.com/photo-1544716278-ca5e3f4abd8c?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80" alt="كتاب الجابر" style="width: 100%; border-radius: 30px;">
                            </div>
                            <div style="flex: 1;">
                                <h2 style="font-size: clamp(2rem, 5vw, 3rem);">كتاب الجابر</h2>
                                <p style="font-size: 1.3rem;">الكتاب الشامل لتعلم اللغة العربية بطريقة مبتكرة (خاص بالصف الثالث الثانوي)</p>
                                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> شرح مبسط ومفهوم</p>
                                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> تمارين تطبيقية شاملة</p>
                                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> أمثلة من الحياة اليومية</p>
                                <p><i class="fas fa-check-circle" style="color: var(--success);"></i> اختبارات تقييمية</p>
                                <h3 style="margin-top: 2rem;">للحجز والاستفسار:</h3>
                                <p style="font-size: 1.5rem; direction: ltr;"><i class="fas fa-phone-alt"></i> 01273740256</p>
                                <a href="https://wa.me/201273740256" class="btn" style="background: #25d366; color: white;"><i class="fab fa-whatsapp"></i> واتساب</a>
                            </div>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderLogin() {
            if (currentUser) { loadPage('dashboard'); return; }
            main.innerHTML = `
                <div class="form-container animate__animated animate__fadeInUp">
                    <h2>تسجيل الدخول</h2>
                    <form id="loginForm">
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                            <input type="email" id="loginEmail" placeholder="example@domain.com" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-lock"></i> كلمة المرور</label>
                            <input type="password" id="loginPassword" placeholder="********" required>
                        </div>
                        <button type="submit" class="btn-submit"><i class="fas fa-sign-in-alt"></i> دخول</button>
                    </form>
                    <p style="text-align: center; margin-top: 1.5rem;">ليس لديك حساب؟ <a href="#" onclick="loadPage('signup')">إنشاء حساب جديد</a></p>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    showToast('تم تسجيل الدخول بنجاح', 'success', 'fa-check-circle');
                    // loadPage ستُستدعى تلقائياً من onAuthStateChanged
                } catch (error) {
                    showToast(error.message, 'error', 'fa-exclamation-circle');
                }
            });
        }

        function renderSignup() {
            if (currentUser) { loadPage('dashboard'); return; }
            // قائمة المحافظات المصرية
            const governorates = [
                'القاهرة', 'الإسكندرية', 'الجيزة', 'القليوبية', 'الشرقية', 'الدقهلية', 'الغربية', 'المنوفية', 'كفر الشيخ',
                'البحيرة', 'دمياط', 'بورسعيد', 'الإسماعيلية', 'السويس', 'شمال سيناء', 'جنوب سيناء', 'بني سويف', 'الفيوم',
                'المنيا', 'أسيوط', 'سوهاج', 'قنا', 'الأقصر', 'أسوان', 'مطروح', 'الوادي الجديد', 'البحر الأحمر'
            ];
            let options = '<option value="">اختر محافظتك</option>';
            governorates.forEach(g => options += `<option>${g}</option>`);

            main.innerHTML = `
                <div class="form-container animate__animated animate__fadeInUp">
                    <h2>إنشاء حساب جديد</h2>
                    <form id="signupForm">
                        <div class="form-group">
                            <label><i class="fas fa-user"></i> الاسم بالكامل</label>
                            <input type="text" id="signupName" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> البريد الإلكتروني</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-map-marker-alt"></i> المحافظة</label>
                            <select id="signupGovernorate" required>${options}</select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-graduation-cap"></i> الصف الدراسي</label>
                            <select id="signupGrade" required>
                                <option value="">اختر الصف</option>
                                <option>الأول الثانوي</option><option>الثاني الثانوي</option><option>الثالث الثانوي</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-school"></i> اسم المعهد</label>
                            <input type="text" id="signupInstitute" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone"></i> تليفون الطالب</label>
                            <input type="tel" id="signupStudentPhone" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-phone-alt"></i> تليفون ولي الأمر</label>
                            <input type="tel" id="signupParentPhone" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-lock"></i> كلمة المرور</label>
                            <input type="password" id="signupPassword" required>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-lock"></i> أعد كتابة كلمة المرور</label>
                            <input type="password" id="signupConfirmPassword" required>
                        </div>
                        <button type="submit" class="btn-submit"><i class="fas fa-user-plus"></i> إنشاء حساب</button>
                    </form>
                    <p style="text-align: center; margin-top: 1.5rem;">لديك حساب بالفعل؟ <a href="#" onclick="loadPage('login')">تسجيل الدخول</a></p>
                </div>
            `;
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('signupName').value;
                const email = document.getElementById('signupEmail').value;
                const governorate = document.getElementById('signupGovernorate').value;
                const grade = document.getElementById('signupGrade').value;
                const institute = document.getElementById('signupInstitute').value;
                const studentPhone = document.getElementById('signupStudentPhone').value;
                const parentPhone = document.getElementById('signupParentPhone').value;
                const password = document.getElementById('signupPassword').value;
                const confirm = document.getElementById('signupConfirmPassword').value;
                if (password !== confirm) {
                    showToast('كلمة المرور غير متطابقة', 'error', 'fa-exclamation-circle');
                    return;
                }
                try {
                    const userCred = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCred.user;
                    const role = (email === 'bo2584668@gmail.com') ? 'admin' : 'user';
                    await setDoc(doc(db, 'users', user.uid), {
                        name, email, governorate, grade, institute, studentPhone, parentPhone, role, createdAt: new Date()
                    });
                    showToast('تم إنشاء الحساب بنجاح', 'success', 'fa-check-circle');
                    // سيتم توجيه المستخدم تلقائياً
                } catch (error) {
                    showToast(error.message, 'error', 'fa-exclamation-circle');
                }
            });
        }

        function renderDashboard() {
            if (!currentUser) { loadPage('login'); return; }
            if (currentUserData.role === 'admin') {
                renderAdmin();
                return;
            }
            main.innerHTML = `
                <section class="dashboard-header">
                    <div class="container">
                        <h2 style="font-size: clamp(1.5rem, 4vw, 2.5rem);">مرحباً ${currentUserData.name}</h2>
                        <p>الصف: ${currentUserData.grade}</p>
                    </div>
                </section>
                <section class="section">
                    <div class="container">
                        <h2 style="text-align: center; font-size: clamp(1.5rem, 4vw, 2.5rem);">كورساتي</h2>
                        <div class="cards-grid" id="studentCoursesGrid"></div>
                    </div>
                </section>
            `;
            loadStudentCourses();
        }

        async function loadStudentCourses() {
            const grid = document.getElementById('studentCoursesGrid');
            if (!grid) return;
            // جلب الكورسات التي تطابق صف الطالب
            const coursesQuery = query(collection(db, 'courses'), where('grade', '==', currentUserData.grade));
            const coursesSnap = await getDocs(coursesQuery);
            if (coursesSnap.empty) {
                grid.innerHTML = '<p class="text-center">لا توجد كورسات متاحة لصفك حالياً</p>';
                return;
            }
            let html = '';
            coursesSnap.forEach(doc => {
                const course = doc.data();
                html += `
                    <div class="card">
                        <div class="card-content">
                            <h3>${course.name}</h3>
                            <button class="btn-card" onclick="loadPage('course?id=${doc.id}')">اضغط لعرض المحتوى</button>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = html;
        }

        // صفحة كورساتي (نفس الداشبورد لكن يمكن تخصيصها)
        function renderMyCourses() {
            if (!currentUser || currentUserData.role !== 'user') { loadPage('login'); return; }
            renderDashboard(); // نفس المحتوى
        }

        async function renderCourse(courseId) {
            if (!courseId) { loadPage('dashboard'); return; }
            const courseDoc = await getDoc(doc(db, 'courses', courseId));
            if (!courseDoc.exists()) { loadPage('dashboard'); return; }
            const course = courseDoc.data();
            
            const lessonsQuery = query(collection(db, 'lessons'), where('courseId', '==', courseId), orderBy('month', 'asc'), orderBy('order', 'asc'));
            const lessonsSnap = await getDocs(lessonsQuery);
            const lessons = [];
            lessonsSnap.forEach(d => lessons.push({ id: d.id, ...d.data() }));

            const months = {};
            lessons.forEach(lesson => {
                const month = lesson.month || 'أخرى';
                if (!months[month]) months[month] = [];
                months[month].push(lesson);
            });

            let hasActiveSub = false;
            if (currentUser && currentUserData.role === 'user') {
                const subQuery = query(collection(db, 'subscriptions'), where('userId', '==', currentUser.uid), where('endDate', '>=', new Date()));
                const subSnap = await getDocs(subQuery);
                hasActiveSub = !subSnap.empty;
            } else if (currentUser && currentUserData.role === 'admin') {
                hasActiveSub = true; // الأدمن يرى كل الدروس
            }

            let lessonsHtml = '';
            for (let month in months) {
                lessonsHtml += `<div class="lesson-group"><h3>محتوى شهر ${month}</h3>`;
                months[month].forEach(lesson => {
                    const locked = lesson.paid && !hasActiveSub;
                    lessonsHtml += `
                        <div class="lesson-item ${locked ? 'locked' : ''}">
                            <span class="title">${lesson.title}</span>
                            ${locked ? '<span class="lock-icon"><i class="fas fa-lock"></i> محتوى مغلق - اشترك الآن</span>' : '<span class="free-icon"><i class="fas fa-unlock"></i> متاح</span>'}
                            ${!locked ? `<button class="btn-small" onclick="viewLesson('${lesson.id}')">عرض</button>` : ''}
                        </div>
                    `;
                });
                lessonsHtml += '</div>';
            }

            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2 style="font-size: clamp(1.5rem, 4vw, 2.5rem);">${course.name}</h2>
                        ${!hasActiveSub && currentUser && currentUserData.role === 'user' ? renderSubscriptionRequest() : ''}
                        <div id="lessonList">${lessonsHtml}</div>
                        <div id="lessonViewer" class="hidden"></div>
                    </div>
                </section>
            `;

            window.viewLesson = async (lessonId) => {
                const lessonDoc = await getDoc(doc(db, 'lessons', lessonId));
                if (!lessonDoc.exists()) return;
                const lesson = lessonDoc.data();
                const videoHtml = lesson.videoUrl ? 
                    (lesson.videoUrl.includes('youtube') ? 
                        `<div class="video-wrapper" style="position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:20px;"><iframe src="https://www.youtube.com/embed/${extractYoutubeId(lesson.videoUrl)}" frameborder="0" allowfullscreen style="position:absolute; top:0; left:0; width:100%; height:100%;"></iframe></div>` 
                        : `<video controls src="${lesson.videoUrl}" style="width:100%; border-radius:20px;"></video>`) 
                    : '<p>لا يوجد فيديو</p>';
                document.getElementById('lessonViewer').innerHTML = `
                    <div class="lesson-content">
                        <h3>${lesson.title}</h3>
                        <p>${lesson.description}</p>
                        ${videoHtml}
                        <button class="btn" onclick="document.getElementById('lessonViewer').classList.add('hidden');document.getElementById('lessonList').classList.remove('hidden');"><i class="fas fa-arrow-right"></i> عودة</button>
                    </div>
                `;
                document.getElementById('lessonViewer').classList.remove('hidden');
                document.getElementById('lessonList').classList.add('hidden');
            };
        }

        function extractYoutubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : '';
        }

        function renderSubscriptionRequest() {
            return `
                <div class="request-form" style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 2rem; border-radius: 30px; margin-bottom: 2rem;">
                    <h3 style="color: var(--primary);"><i class="fas fa-key"></i> تفعيل الاشتراك</h3>
                    <p>سعر الاشتراك: <strong>شهري 100 جنيه</strong> | <strong>ترم 300 جنيه</strong></p>
                    <p>لتفعيل الاشتراك يرجى تحويل فودافون كاش على الأرقام التالية:</p>
                    <ul style="list-style: none; padding: 0;">
                        <li><i class="fas fa-phone"></i> 01097841446</li>
                        <li><i class="fas fa-phone"></i> 01033781752</li>
                        <li><i class="fas fa-phone"></i> 01044768288</li>
                    </ul>
                    <form id="subRequestForm">
                        <div class="form-group">
                            <label>نوع الاشتراك</label>
                            <select id="subType" required>
                                <option value="monthly">شهري (100 جنيه)</option>
                                <option value="semester">ترم (300 جنيه)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف المحول منه</label>
                            <input type="tel" id="subPhone" required>
                        </div>
                        <div class="form-group">
                            <label>صورة الإيصال</label>
                            <input type="file" id="subReceipt" accept="image/*" required>
                        </div>
                        <button type="submit" class="btn-submit"><i class="fas fa-paper-plane"></i> إرسال الطلب</button>
                    </form>
                </div>
            `;
            setTimeout(() => {
                document.getElementById('subRequestForm')?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!currentUser) { showToast('يجب تسجيل الدخول أولاً', 'error', 'fa-exclamation-circle'); return; }
                    const type = document.getElementById('subType').value;
                    const phone = document.getElementById('subPhone').value;
                    const file = document.getElementById('subReceipt').files[0];
                    if (!file) { showToast('اختر صورة الإيصال', 'warning', 'fa-exclamation-triangle'); return; }
                    try {
                        const storageRef = ref(storage, `receipts/${currentUser.uid}_${Date.now()}.jpg`);
                        await uploadBytes(storageRef, file);
                        const url = await getDownloadURL(storageRef);
                        await addDoc(collection(db, 'subscriptionRequests'), {
                            userId: currentUser.uid,
                            userName: currentUserData.name,
                            userGrade: currentUserData.grade,
                            type,
                            phone,
                            receiptUrl: url,
                            status: 'pending',
                            createdAt: new Date()
                        });
                        showToast('تم تقديم الطلب بنجاح، سيتم مراجعته قريباً', 'success', 'fa-check-circle');
                    } catch (error) {
                        showToast(error.message, 'error', 'fa-exclamation-circle');
                    }
                });
            }, 100);
        }

        // ========== Admin Panel ==========
        async function renderAdmin() {
            if (!currentUser || currentUserData.role !== 'admin') { loadPage('home'); return; }
            main.innerHTML = `
                <section class="section">
                    <div class="container">
                        <h2 style="font-size: clamp(1.5rem, 4vw, 2.5rem);">قسم الإدارة</h2>
                        <div class="admin-tabs">
                            <div class="admin-tab active" data-admin-tab="requests">طلبات الاشتراك</div>
                            <div class="admin-tab" data-admin-tab="lessons">إدارة الدروس</div>
                            <div class="admin-tab" data-admin-tab="courses">إدارة الكورسات</div>
                            <div class="admin-tab" data-admin-tab="users">إدارة المستخدمين</div>
                        </div>
                        <div id="adminRequests" class="admin-section active"></div>
                        <div id="adminLessons" class="admin-section"></div>
                        <div id="adminCourses" class="admin-section"></div>
                        <div id="adminUsers" class="admin-section"></div>
                    </div>
                </section>
            `;

            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
                    document.getElementById('admin' + tab.dataset.adminTab.charAt(0).toUpperCase() + tab.dataset.adminTab.slice(1)).classList.add('active');
                });
            });

            loadRequests();
            loadLessonsTab();
            loadCoursesTab();
            loadUsersTab();
        }

        async function loadRequests() {
            const div = document.getElementById('adminRequests');
            const requestsSnap = await getDocs(collection(db, 'subscriptionRequests'));
            let html = `
                <h3>طلبات الاشتراك</h3>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>الطالب</th><th>الصف</th><th>النوع</th><th>الهاتف</th><th>الإيصال</th><th>الحالة</th><th>الإجراء</th></tr></thead>
                        <tbody>
            `;
            requestsSnap.forEach(doc => {
                const req = doc.data();
                html += `
                    <tr>
                        <td>${req.userName}</td>
                        <td>${req.userGrade}</td>
                        <td>${req.type === 'monthly' ? 'شهري' : 'ترم'}</td>
                        <td>${req.phone}</td>
                        <td><a href="${req.receiptUrl}" target="_blank" style="color: var(--accent);"><i class="fas fa-eye"></i> عرض</a></td>
                        <td><span class="badge pending">${req.status}</span></td>
                        <td>
                            ${req.status === 'pending' ? `<button class="btn-small" onclick="approveRequest('${doc.id}', '${req.userId}', '${req.type}')">تفعيل</button>` : ''}
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            div.innerHTML = html;

            window.approveRequest = async (reqId, userId, type) => {
                const now = new Date();
                const endDate = new Date(now);
                if (type === 'monthly') endDate.setDate(now.getDate() + 30);
                else endDate.setMonth(now.getMonth() + 5);
                await addDoc(collection(db, 'subscriptions'), {
                    userId,
                    type,
                    startDate: now,
                    endDate: endDate,
                    createdAt: now
                });
                await updateDoc(doc(db, 'subscriptionRequests', reqId), { status: 'approved' });
                showToast('تم تفعيل الاشتراك', 'success', 'fa-check-circle');
                loadRequests();
            };
        }

        async function loadLessonsTab() {
            const div = document.getElementById('adminLessons');
            const coursesSnap = await getDocs(collection(db, 'courses'));
            let courseOptions = '';
            coursesSnap.forEach(doc => {
                courseOptions += `<option value="${doc.id}">${doc.data().name}</option>`;
            });

            div.innerHTML = `
                <h3>إضافة درس جديد</h3>
                <form id="addLessonForm">
                    <div class="form-group">
                        <label>الكورس</label>
                        <select id="lessonCourse" required>${courseOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>الشهر</label>
                        <select id="lessonMonth" required>
                            <option value="يناير">يناير</option><option value="فبراير">فبراير</option><option value="مارس">مارس</option><option value="أبريل">أبريل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>عنوان الدرس</label>
                        <input type="text" id="lessonTitle" required>
                    </div>
                    <div class="form-group">
                        <label>وصف الدرس</label>
                        <textarea id="lessonDesc" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>رابط يوتيوب (أو رفع فيديو)</label>
                        <input type="text" id="lessonVideo" placeholder="https://youtu.be/...">
                        <input type="file" id="lessonVideoFile" accept="video/*">
                    </div>
                    <div class="form-group">
                        <label>صورة مصغرة</label>
                        <input type="file" id="lessonThumb" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label><input type="checkbox" id="lessonPaid"> درس مدفوع</label>
                    </div>
                    <button type="submit" class="btn-submit">نشر الدرس</button>
                </form>
                <hr>
                <h3>الدروس الموجودة</h3>
                <div id="lessonsList"></div>
            `;

            document.getElementById('addLessonForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const courseId = document.getElementById('lessonCourse').value;
                const month = document.getElementById('lessonMonth').value;
                const title = document.getElementById('lessonTitle').value;
                const desc = document.getElementById('lessonDesc').value;
                const videoUrl = document.getElementById('lessonVideo').value;
                const videoFile = document.getElementById('lessonVideoFile').files[0];
                const thumbFile = document.getElementById('lessonThumb').files[0];
                const paid = document.getElementById('lessonPaid').checked;

                let finalVideoUrl = videoUrl;
                if (videoFile) {
                    const storageRef = ref(storage, `videos/${Date.now()}_${videoFile.name}`);
                    await uploadBytes(storageRef, videoFile);
                    finalVideoUrl = await getDownloadURL(storageRef);
                }
                let thumbUrl = '';
                if (thumbFile) {
                    const thumbRef = ref(storage, `thumbs/${Date.now()}_${thumbFile.name}`);
                    await uploadBytes(thumbRef, thumbFile);
                    thumbUrl = await getDownloadURL(thumbRef);
                }

                await addDoc(collection(db, 'lessons'), {
                    courseId, month, title, description: desc, videoUrl: finalVideoUrl, thumbUrl, paid, order: Date.now(), createdAt: new Date()
                });
                showToast('تم إضافة الدرس', 'success', 'fa-check-circle');
                loadLessonsList();
            });

            loadLessonsList();
        }

        async function loadLessonsList() {
            const div = document.getElementById('lessonsList');
            if (!div) return;
            const lessonsSnap = await getDocs(collection(db, 'lessons'));
            let html = '<div class="table-responsive"><table><tr><th>العنوان</th><th>الشهر</th><th>الإجراء</th></tr>';
            lessonsSnap.forEach(doc => {
                const lesson = doc.data();
                html += `<tr><td>${lesson.title}</td><td>${lesson.month}</td><td><button class="btn-small" onclick="deleteLesson('${doc.id}')">حذف</button></td></tr>`;
            });
            html += '</table></div>';
            div.innerHTML = html;

            window.deleteLesson = async (id) => {
                if (confirm('هل أنت متأكد؟')) {
                    await deleteDoc(doc(db, 'lessons', id));
                    showToast('تم الحذف', 'success');
                    loadLessonsList();
                }
            };
        }

        async function loadCoursesTab() {
            const div = document.getElementById('adminCourses');
            div.innerHTML = `
                <h3>إضافة كورس جديد</h3>
                <form id="addCourseForm">
                    <div class="form-group">
                        <label>اسم الكورس</label>
                        <input type="text" id="courseName" required>
                    </div>
                    <div class="form-group">
                        <label>الوصف</label>
                        <textarea id="courseDesc" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>الصف</label>
                        <input type="text" id="courseGrade" placeholder="مثال: الأول الثانوي" required>
                    </div>
                    <button type="submit" class="btn-submit">إضافة</button>
                </form>
                <hr>
                <h3>الكورسات الحالية</h3>
                <div id="coursesList"></div>
            `;

            document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('courseName').value;
                const desc = document.getElementById('courseDesc').value;
                const grade = document.getElementById('courseGrade').value;
                await addDoc(collection(db, 'courses'), { name, description: desc, grade });
                showToast('تم إضافة الكورس', 'success');
                loadCoursesList();
            });

            loadCoursesList();
        }

        async function loadCoursesList() {
            const div = document.getElementById('coursesList');
            if (!div) return;
            const coursesSnap = await getDocs(collection(db, 'courses'));
            let html = '<div class="table-responsive"><table><tr><th>الاسم</th><th>الصف</th><th>الإجراء</th></tr>';
            coursesSnap.forEach(doc => {
                const course = doc.data();
                html += `<tr><td>${course.name}</td><td>${course.grade}</td><td><button class="btn-small" onclick="deleteCourse('${doc.id}')">حذف</button></td></tr>`;
            });
            html += '</table></div>';
            div.innerHTML = html;

            window.deleteCourse = async (id) => {
                if (confirm('هل أنت متأكد؟')) {
                    await deleteDoc(doc(db, 'courses', id));
                    showToast('تم الحذف', 'success');
                    loadCoursesList();
                }
            };
        }

        async function loadUsersTab() {
            const div = document.getElementById('adminUsers');
            const usersSnap = await getDocs(collection(db, 'users'));
            let html = '<h3>المستخدمين</h3><div class="table-responsive"><table><tr><th>الاسم</th><th>البريد</th><th>الصف</th><th>الدور</th><th>الإجراء</th></tr>';
            usersSnap.forEach(doc => {
                const user = doc.data();
                html += `<tr>
                    <td>${user.name || ''}</td>
                    <td>${user.email}</td>
                    <td>${user.grade || ''}</td>
                    <td><span class="badge ${user.role}">${user.role}</span></td>
                    <td>
                        ${user.role !== 'admin' ? `<button class="btn-small" onclick="makeAdmin('${doc.id}')">ترقية لأدمن</button>` : ''}
                    </td>
                </tr>`;
            });
            html += '</table></div>';
            div.innerHTML = html;

            window.makeAdmin = async (uid) => {
                await updateDoc(doc(db, 'users', uid), { role: 'admin' });
                showToast('تمت الترقية', 'success');
                loadUsersTab();
            };
        }

        // ========== Helper Functions ==========
        window.loadPage = loadPage;
    </script>
</body>
</html>
