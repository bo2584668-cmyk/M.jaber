<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل الكورس - منصة محمد جابر</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Tajawal',sans-serif; }
        body { background:#f5f7fa; }
        .navbar {
            background:white; box-shadow:0 2px 10px rgba(0,0,0,0.05); padding:1rem 5%;
            display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap;
        }
        .logo { font-size:1.6rem; font-weight:900; color:#1e3c5c; }
        .nav-links { display:flex; gap:2rem; }
        .nav-links a { text-decoration:none; color:#1e2a3a; font-weight:600; transition:0.3s; }
        .nav-links a:hover { color:#f9a826; }
        .logout-btn {
            background:#dc3545; color:white; border:none; padding:0.5rem 1.5rem;
            border-radius:50px; cursor:pointer; font-weight:600;
        }
        .container { max-width:1000px; margin:2rem auto; padding:0 2rem; }
        .course-header {
            background:white; border-radius:30px; padding:2rem; margin-bottom:2rem;
            box-shadow:0 10px 30px rgba(0,0,0,0.05);
        }
        .course-header h1 { color:#1e3c5c; font-size:2.2rem; margin-bottom:1rem; }
        .course-meta {
            display:flex; gap:2rem; flex-wrap:wrap; margin:1.5rem 0;
            padding:1rem 0; border-top:1px solid #eee; border-bottom:1px solid #eee;
        }
        .meta-item { display:flex; align-items:center; gap:0.5rem; color:#555; }
        .meta-item i { color:#f9a826; }
        .badge {
            background:#f9a826; color:white; padding:0.3rem 1.5rem; border-radius:50px;
            font-weight:700; display:inline-block;
        }
        .badge.free { background:#28a745; }
        .badge.paid { background:#dc3545; }
        .video-section {
            background:white; border-radius:30px; padding:2rem; margin-bottom:2rem;
            box-shadow:0 10px 30px rgba(0,0,0,0.05); text-align:center;
        }
        .video-placeholder {
            background:#1e3c5c; color:white; padding:3rem; border-radius:20px;
            font-size:1.5rem; margin-bottom:1.5rem;
        }
        .video-placeholder i { font-size:4rem; margin-bottom:1rem; }
        .watch-btn {
            display:inline-block; background:#f9a826; color:#1e2a3a; padding:1rem 3rem;
            border-radius:50px; text-decoration:none; font-weight:700; font-size:1.2rem;
            transition:0.3s; border:none; cursor:pointer;
        }
        .watch-btn:hover { transform:translateY(-3px); box-shadow:0 10px 20px rgba(249,168,38,0.3); }
        .watch-btn:disabled { background:#ccc; cursor:not-allowed; transform:none; }
        .subscribe-section {
            background:#f0f5fa; border-radius:20px; padding:2rem; text-align:center;
        }
        .subscribe-section h3 { color:#1e3c5c; margin-bottom:1rem; }
        .subscribe-btn {
            background:#1e3c5c; color:white; padding:0.8rem 2rem; border-radius:50px;
            text-decoration:none; font-weight:600; display:inline-block; margin-top:1rem;
        }
        .message { margin:1rem 0; color:#dc3545; font-weight:600; }
        .loading { text-align:center; padding:2rem; }
        /* تنسيق iframe ليستجيب */
        .iframe-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* نسبة 16:9 */
            height: 0;
            overflow: hidden;
            border-radius: 20px;
            margin-bottom: 1.5rem;
        }
        .iframe-container iframe {
            position: absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            border:0;
        }
        @media (max-width:768px) {
            .navbar { flex-direction:column; gap:1rem; }
            .nav-links { gap:1rem; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">منصة محمد جابر</div>
        <div class="nav-links">
            <a href="dashboard.html">الرئيسية</a>
            <a href="courses.html">كل الكورسات</a>
            <a href="subscription.html">الاشتراكات</a>
        </div>
        <button class="logout-btn" id="logout">تسجيل خروج</button>
    </nav>
    <div class="container">
        <div id="courseDetails" class="course-header">
            <!-- يتم تعبئة البيانات عبر JavaScript -->
        </div>

        <div id="videoSection" class="video-section">
            <!-- سيتم عرض الفيديو حسب الصلاحية والنوع -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCoG63qojGugIkvc7-T0M7BnP4KRMQuyrE",
            authDomain: "mr-jabr.firebaseapp.com",
            projectId: "mr-jabr",
            storageBucket: "mr-jabr.firebasestorage.app",
            messagingSenderId: "563345828466",
            appId: "1:563345828466:web:f0bdd40711c935f60d30eb"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        if (!courseId) {
            window.location.href = 'courses.html';
        }

        let currentUser = null;
        let userData = null;
        let courseData = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                currentUser = null;
                userData = null;
                loadCourseDetails();
            } else {
                currentUser = user;
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                userData = userDoc.exists() ? userDoc.data() : null;
                loadCourseDetails();
            }
        });

        async function loadCourseDetails() {
            const courseRef = doc(db, 'courses', courseId);
            const courseSnap = await getDoc(courseRef);

            if (!courseSnap.exists()) {
                document.querySelector('.container').innerHTML = '<h2>الكورس غير موجود</h2>';
                return;
            }

            courseData = courseSnap.data();

            // عرض رأس الكورس
            const courseHeader = document.getElementById('courseDetails');
            courseHeader.innerHTML = `
                <h1>${courseData.title}</h1>
                <p>${courseData.description}</p>
                <div class="course-meta">
                    <span class="meta-item"><i class="fas fa-chalkboard-teacher"></i> ${courseData.instructor || 'محمد جابر'}</span>
                    <span class="meta-item"><i class="fas fa-graduation-cap"></i> ${courseData.grade || 'عام'}</span>
                    <span class="meta-item"><i class="fas fa-video"></i> ${courseData.videoCount || 12} درس</span>
                </div>
                <span class="badge ${courseData.isFree ? 'free' : 'paid'}">${courseData.isFree ? 'مجاني' : 'مدفوع'}</span>
            `;

            // التحقق من صلاحية مشاهدة الفيديو
            const videoSection = document.getElementById('videoSection');
            const canWatch = courseData.isFree || (userData && userData.isActive === true);

            if (!canWatch) {
                videoSection.innerHTML = `
                    <div class="video-placeholder">
                        <i class="fas fa-lock"></i>
                        <p>هذا الكورس مدفوع ويتطلب اشتراكاً نشطاً</p>
                    </div>
                    <div class="subscribe-section">
                        <h3>لست مشتركاً؟</h3>
                        <p>اشترك الآن للوصول إلى جميع الكورسات المدفوعة</p>
                        <a href="subscription.html" class="subscribe-btn">اطلب اشتراكك الآن</a>
                    </div>
                `;
                return;
            }

            // عرض المحتوى حسب النوع (iframe أو رابط يوتيوب)
            if (courseData.iframeCode) {
                // إزالة أي نصوص خطرة والحفاظ على iframe فقط
                // بافتراض أن الكود آمن (لأنه من الأدمن)
                videoSection.innerHTML = `
                    <div class="iframe-container">
                        ${courseData.iframeCode}
                    </div>
                `;
                // يمكن إضافة زر لفتحه في نافذة جديدة إذا أردت
            } else if (courseData.videoUrl) {
                videoSection.innerHTML = `
                    <div class="video-placeholder">
                        <i class="fas fa-play-circle"></i>
                        <p>اضغط على الزر لمشاهدة الفيديو</p>
                    </div>
                    <a href="${courseData.videoUrl}" target="_blank" class="watch-btn">
                        <i class="fas fa-play"></i> مشاهدة الفيديو
                    </a>
                `;
            } else {
                videoSection.innerHTML = `
                    <div class="video-placeholder">
                        <i class="fas fa-video-slash"></i>
                        <p>لا يوجد فيديو لهذا الكورس حالياً</p>
                    </div>
                `;
            }
        }

        document.getElementById('logout').addEventListener('click', async () => {
            await signOut(auth);
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
